<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ì¥ë°”êµ¬ë‹ˆ</title>
    <link rel="stylesheet" href="/css/cart.css" />
</head>
<body>

<div class="cart-container">
    <h2>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2>

    <div class="cart-header">
        <label><input type="checkbox" id="select-all" /> ì „ì²´ ì„ íƒ</label>
        <button id="delete-selected">ì„ íƒ ì‚­ì œ</button>
    </div>

    <div id="cart-items">
        <!-- ìƒí’ˆ ì•„ì´í…œë“¤ì´ JSë¡œ ë Œë”ë§ë©ë‹ˆë‹¤ -->
    </div>

    <div class="cart-footer">
        <button id="change-options">ì˜µì…˜/ë°°ì†¡ ë³€ê²½</button>
        <button id="order-now">ë°”ë¡œ ì£¼ë¬¸</button>
        <div class="price-summary">
            <p>ìƒí’ˆ ê¸ˆì•¡: <span id="total-price">0ì›</span></p>
            <p>ë°°ì†¡ë¹„: <span id="delivery-fee">0ì›</span></p>
            <p>ì˜ˆìƒ ê²°ì œê¸ˆì•¡: <span id="total-payment">0ì›</span></p>
        </div>
    </div>
</div>

<script>
    // [FIX] memberId í•˜ë“œì½”ë”© ì œê±°. ì„œë²„ê°€ ì¸ì¦ ì£¼ì²´ì—ì„œ ì‹ë³„.
    // const memberId = 1;

    // [FIX] ê³µí†µ fetch ì˜µì…˜ í—¬í¼: ì¿ í‚¤ ì „ì†¡( HttpOnly JWT )
    function withAuth(init = {}) {
        return Object.assign(
            {
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', ...(init.headers || {}) }
            },
            init
        );
    }

    // [FIX] 401/302 ëŒ€ì‘: APIê°€ 401 ì£¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
    async function handleJson(res) {
        if (res.status === 401) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = '/login';
            return Promise.reject(new Error('Unauthorized'));
        }
        if (res.status >= 300 && res.status < 400) {
            // API ì²´ì¸ì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ ì˜¤ë©´(ì˜¬ ì¼ ì—†ê²Œ ìˆ˜ì •í–ˆì§€ë§Œ ë°©ì–´)
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            location.href = '/login';
            return Promise.reject(new Error('Redirected'));
        }
        if (!res.ok) throw new Error('ìš”ì²­ ì‹¤íŒ¨: ' + res.status);
        return res.json();
    }

    // ì„œë²„ì—ì„œ ë‚´ ì¥ë°”êµ¬ë‹ˆ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
    async function fetchCartItems() {
        try {
            // [FIX] /api/v1/cart/{memberId} â†’ /api/v1/cart/my
            const res = await fetch(`/api/v1/cart/my`, withAuth());
            const cartItems = await handleJson(res);
            renderCart(cartItems);
        } catch (err) {
            alert(err.message);
        }
    }

    // ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ë Œë”ë§
    function renderCart(cartItems) {
        const container = document.getElementById('cart-items');
        container.innerHTML = '';

        if (!cartItems || cartItems.length === 0) {
            container.innerHTML = '<p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>';
            updatePriceSummary(0);
            return;
        }

        cartItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `
                <input type="checkbox" class="item-select" data-cart-id="${item.id}" />
                <img src="${item.productThumbnailUrl || '/images/default-product.png'}" alt="${item.productName}" class="product-img" />
                <div class="product-info">
                  <strong>${item.productName}</strong><br />
                  <small>ì‚¬ì´ì¦ˆ: ${item.size || '-'}</small><br />
                  <small>ìƒí’ˆ ì½”ë“œ: ${item.productMgtId}</small>
                </div>
                <div class="price-info">
                  <span>${Number(item.price).toLocaleString()}ì›</span>
                  <input type="number" min="1" value="${item.count}"
                    onchange="updateCount(${item.id}, this.value)" />
                  <button onclick="deleteCartItem(${item.id})">ì‚­ì œ</button>
                </div>
            `;
            container.appendChild(div);
        });

        calculatePrice();
    }

    // ìˆ˜ëŸ‰ ë³€ê²½ ì„œë²„ ìš”ì²­
    function updateCount(cartId, newCount) {
        if (newCount < 1) {
            alert('ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            fetchCartItems(); // ìˆ˜ëŸ‰ ë³µêµ¬
            return;
        }
        fetch(`/api/v1/cart/${cartId}`, withAuth({
            method: 'PUT',
            body: JSON.stringify({ quantity: parseInt(newCount, 10) }) // [FIX] ì„œë²„ DTO í‚¤ì— ë§ì¶¤
        }))
        .then(handleJson)
        .then(() => calculatePrice())
        .catch(err => {
            alert(err.message);
            fetchCartItems(); // ë³µêµ¬
        });
    }

    // ê°œë³„ ì‚­ì œ
    function deleteCartItem(cartId) {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        fetch(`/api/v1/cart/${cartId}`, withAuth({ method: 'DELETE' }))
            .then(res => {
                if (res.status === 401) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); location.href='/login'; return Promise.reject(); }
                if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                return res.text();
            })
            .then(() => fetchCartItems())
            .catch(err => err && alert(err.message));
    }

    // ì „ì²´ ì„ íƒ í† ê¸€
    document.getElementById('select-all').addEventListener('change', function () {
        const checked = this.checked;
        document.querySelectorAll('.item-select').forEach(cb => cb.checked = checked);
    });

    // ì„ íƒ ì‚­ì œ
    document.getElementById('delete-selected').addEventListener('click', () => {
        const selected = [...document.querySelectorAll('.item-select:checked')];
        if (selected.length === 0) return alert("ì„ íƒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
        if (!confirm(`${selected.length}ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        Promise.all(selected.map(cb => {
            const cartId = cb.dataset.cartId;
            return fetch(`/api/v1/cart/${cartId}`, withAuth({ method: 'DELETE' }))
                .then(res => { if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨'); });
        }))
        .then(() => fetchCartItems())
        .catch(() => alert('ì‚­ì œ ì‹¤íŒ¨'));
    });

    // ê°€ê²© ê³„ì‚° í•¨ìˆ˜
    function calculatePrice() {
        const items = document.querySelectorAll('.cart-item');
        let totalPrice = 0;

        items.forEach(item => {
            const priceText = item.querySelector('.price-info span').textContent.replace(/[^0-9]/g, '');
            const count = item.querySelector('input[type=number]').value;
            totalPrice += parseInt(priceText, 10) * parseInt(count, 10);
        });

        updatePriceSummary(totalPrice);
    }

    // ê°€ê²© ìš”ì•½ ì—…ë°ì´íŠ¸
    function updatePriceSummary(totalPrice) {
        const deliveryFee = totalPrice >= 50000 ? 0 : 5000;
        document.getElementById('total-price').textContent = totalPrice.toLocaleString() + 'ì›';
        document.getElementById('delivery-fee').textContent = deliveryFee.toLocaleString() + 'ì›';
        document.getElementById('total-payment').textContent = (totalPrice + deliveryFee).toLocaleString() + 'ì›';
    }

    // ì´ˆê¸° ë¡œë“œ
    fetchCartItems();
</script>

</body>
</html>
