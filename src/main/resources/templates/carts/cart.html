<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì¥ë°”êµ¬ë‹ˆ</title>
    <link rel="stylesheet" href="/css/cart.css" />
</head>
<body>

<div class="cart-container">
    <h2>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2>

    <div class="cart-header">
        <label><input type="checkbox" id="select-all" /> ì „ì²´ ì„ íƒ</label>
        <button id="delete-selected">ì„ íƒ ì‚­ì œ</button>
    </div>

    <div id="cart-items">
        <!-- JSë¡œ ì¥ë°”êµ¬ë‹ˆ í•­ëª© ë Œë”ë§ -->
    </div>

    <div class="cart-footer">
        <button id="change-options">ì˜µì…˜/ë°°ì†¡ ë³€ê²½</button>
        <button id="order-now">ë°”ë¡œ ì£¼ë¬¸</button>
        <div class="price-summary">
            <p>ìƒí’ˆ ê¸ˆì•¡: <span id="total-price">0ì›</span></p>
            <p>ë°°ì†¡ë¹„: <span id="delivery-fee">0ì›</span></p>
            <p>ì˜ˆìƒ ê²°ì œê¸ˆì•¡: <span id="total-payment">0ì›</span></p>
        </div>
    </div>
</div>

<script>
    
    // âœ… withAuth: JWT ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦ ìš”ì²­ìš© ì„¤ì •
    // credentials: 'include' ë¡œ ì¿ í‚¤ ì „ì†¡
    function withAuth(init={}) {
        return Object.assign({
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            redirect: 'manual'
        }, init);
    }

    
    // âœ… ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ
    async function fetchCartItems() {
        const res = await fetch('/api/v1/cart/my', withAuth());
        if (!res.ok) throw new Error("ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ ì‹¤íŒ¨");
        const data = await res.json();
        renderCart(data.cartItems);
    }

    
    // âœ… ì¥ë°”êµ¬ë‹ˆ ë Œë”ë§
    // ì›ê°€ê²©/í• ì¸ìœ¨/ì´ê¸ˆì•¡ í‘œì‹œ
    // ìˆ˜ëŸ‰ ë³€ê²½/ì‚­ì œ/ì „ì²´ ì„ íƒ ê¸°ëŠ¥ í¬í•¨
    function renderCart(cartItems) {
        const container = document.getElementById('cart-items');
        container.innerHTML = '';

        if (!cartItems.length) {
            container.innerHTML = '<p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>';
            updatePriceSummary(0);
            return;
        }

        cartItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `
                <input type="checkbox" class="item-select" data-cart-id="${item.id}" />
                <img src="${item.productThumbnailUrl}" alt="${item.productName}" class="product-img" />
                <div class="product-info">
                    <strong>${item.productName}</strong><br/>
                    <small>ì‚¬ì´ì¦ˆ: ${item.size}</small>
                    <small>ì£¼ë¬¸ì: ${item.memberName}</small><br/>
                    <small>ì „í™”ë²ˆí˜¸: ${item.phoneNumber}</small>
                </div>
                <div class="price-info">
                    <span class="original-price">${Number(item.originalPrice).toLocaleString()}ì›</span>
                    <span class="discount-rate">${item.discountRate}% í• ì¸</span>
                    <span class="final-price">${Number(item.finalPrice).toLocaleString()}ì›</span>
                    <input type="number" min="1" value="${item.quantity}" onchange="updateCount(${item.id}, this.value)" />
                    <button onclick="deleteCartItem(${item.id})">ì‚­ì œ</button><br/>
                    <span class="total-price">ì´ì•¡: ${Number(item.totalPrice).toLocaleString()}ì›</span>
                </div>
            `;
            container.appendChild(div);
        });

        
        // âœ… ì£¼ë¬¸í•˜ê¸° í´ë¦­ ì‹œ tempOrder.htmlë¡œ ì´ë™
        // ì„ íƒ ìƒí’ˆë§Œ sessionStorageì— ë‹´ìŒ
        document.getElementById('order-now').onclick = handleOrderNow;
        calculatePrice();
    }

    
    // âœ… ìˆ˜ëŸ‰ ë³€ê²½
    function updateCount(cartId, newCount) {
        if (newCount < 1) { alert('ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); fetchCartItems(); return; }
        fetch(`/api/v1/cart/${cartId}`, withAuth({ method:'PUT', body:JSON.stringify({ quantity: parseInt(newCount, 10) }) }))
            .then(res => res.ok ? fetchCartItems() : Promise.reject('ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨'))
            .catch(err => { alert(err); fetchCartItems(); });
    }

    
    // âœ… ê°œë³„ ì‚­ì œ
    function deleteCartItem(cartId) {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        fetch(`/api/v1/cart/${cartId}`, withAuth({ method:'DELETE' }))
            .then(res => res.ok ? fetchCartItems() : Promise.reject('ì‚­ì œ ì‹¤íŒ¨'))
            .catch(err => alert(err));
    }

    
    // âœ… ì£¼ë¬¸í•˜ê¸° í´ë¦­ ì´ë²¤íŠ¸
    // - JWT ì¿ í‚¤ë¡œ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ í™•ì¸
    // - ì„ íƒ ìƒí’ˆë§Œ sessionStorageì— ì €ì¥
    async function handleOrderNow() {
        const selectedItems = [...document.querySelectorAll('.item-select:checked')];
        if (!selectedItems.length) return alert('ì„ íƒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');

        let memberInfo;
        try {
            const res = await fetch('/api/v1/members/me', withAuth());
            if (!res.ok) throw new Error('íšŒì› ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
            memberInfo = await res.json();
        } catch(e) { alert(e); return; }

        const orderProducts = selectedItems.map(cb => {
            const itemDiv = cb.closest('.cart-item');
            return {
                cartId: parseInt(cb.dataset.cartId),
                name: itemDiv.querySelector('.product-info strong').textContent,
                size: itemDiv.querySelector('.product-info small').textContent.replace('ì‚¬ì´ì¦ˆ: ',''),
                image: itemDiv.querySelector('img').src,
                quantity: parseInt(itemDiv.querySelector('input[type=number]').value, 10),
                originalPrice: parseInt(itemDiv.querySelector('.original-price').textContent.replace(/[^0-9]/g,''),10),
                discountRate: parseInt(itemDiv.querySelector('.discount-rate').textContent.replace(/[^0-9]/g,''),10),
                finalPrice: parseInt(itemDiv.querySelector('.final-price').textContent.replace(/[^0-9]/g,''),10),
                price: parseInt(itemDiv.querySelector('.total-price').textContent.replace(/[^0-9]/g,''),10)
            };
        });

        const totalPrice = orderProducts.reduce((sum,p)=>sum+p.price,0);
        const deliveryFee = totalPrice >= 50000 ? 0 : 5000;

        const orderDto = {
            memberId: memberInfo.id,
            ordererName: memberInfo.ordererName,
            phoneNumber: memberInfo.phoneNumber,
            totalPrice: totalPrice + deliveryFee,
            deliveryFee,
            products: orderProducts
        };

        sessionStorage.setItem('orderDto', JSON.stringify(orderDto));
        window.location.href = '/tempOrder';
    }

    
    // âœ… í•©ê³„ ê³„ì‚° ë° UI ë°˜ì˜
    function calculatePrice() {
        let total = 0;
        document.querySelectorAll('.cart-item').forEach(item => {
            const totalText = item.querySelector('.total-price').textContent.replace(/[^0-9]/g,'');
            total += parseInt(totalText,10);
        });
        updatePriceSummary(total);
    }

    function updatePriceSummary(totalPrice) {
        const deliveryFee = totalPrice >= 50000 ? 0 : 5000;
        document.getElementById('total-price').textContent = totalPrice.toLocaleString()+'ì›';
        document.getElementById('delivery-fee').textContent = deliveryFee.toLocaleString()+'ì›';
        document.getElementById('total-payment').textContent = (totalPrice+deliveryFee).toLocaleString()+'ì›';
    }

    
    // âœ… ì„ íƒ ì‚­ì œ & ì „ì²´ ì„ íƒ ê¸°ëŠ¥
    document.getElementById('delete-selected').addEventListener('click', () => {
        const selected = [...document.querySelectorAll('.item-select:checked')];
        if (!selected.length) return alert('ì„ íƒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
        if (!confirm(`${selected.length}ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        Promise.all(selected.map(cb=>fetch(`/api/v1/cart/${cb.dataset.cartId}`,withAuth({method:'DELETE'}))))
            .then(()=>fetchCartItems())
            .catch(()=>alert('ì‚­ì œ ì‹¤íŒ¨'));
    });

    document.getElementById('select-all').addEventListener('change', function() {
        document.querySelectorAll('.item-select').forEach(cb=>cb.checked=this.checked);
    });

    fetchCartItems();
</script>

</body>
</html>
