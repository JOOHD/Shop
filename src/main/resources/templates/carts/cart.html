<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>장바구니</title>
    <link rel="stylesheet" href="/css/cart.css" />
</head>
<body>

<div class="cart-container">
    <h2>🛒 장바구니</h2>

    <div class="cart-header">
        <label><input type="checkbox" id="select-all" /> 전체 선택</label>
        <button id="delete-selected">선택 삭제</button>
    </div>

    <div id="cart-items">
        <!-- 상품 아이템들이 JS로 렌더링됩니다 -->
    </div>

    <div class="cart-footer">
        <button id="change-options">옵션/배송 변경</button>
        <button id="order-now">바로 주문</button>
        <div class="price-summary">
            <p>상품 금액: <span id="total-price">0원</span></p>
            <p>배송비: <span id="delivery-fee">0원</span></p>
            <p>예상 결제금액: <span id="total-payment">0원</span></p>
        </div>
    </div>
</div>

<script>
    // ================== 공통 fetch 옵션 ==================
    function withAuth(init = {}) {
        return Object.assign({
            credentials: 'include', // 쿠키 전송
            headers: {
                'Content-Type': 'application/json',
                ...(init.headers || {})
            },
            redirect: 'manual' // 302 자동 follow 방지
        }, init);
    }

    // ================== JSON 처리 ==================
    async function handleJson(res) {
        if (res.status === 401) {
            alert('로그인이 필요합니다.');
            location.href = '/login';
            return Promise.reject(new Error('Unauthorized'));
        }
        if (!res.ok) throw new Error('요청 실패: ' + res.status);
        return res.json();
    }

    // ================== JWT에서 memberId 추출 ==================
    function getMemberIdFromJWT() {
        // 실제 JWT 파싱 로직 필요
        // 예: accessToken을 쿠키에서 가져와서 payload decode 후 memberId 반환
        return parseInt(localStorage.getItem("memberId") || "0"); // 테스트용
    }

    // ================== 장바구니 조회 ==================
    async function fetchCartItems() {
        try {
            const res = await fetch('/api/v1/cart/my', withAuth({ method: 'GET' }));
            const cartItems = await handleJson(res); // 서버가 배열 반환
            renderCart(cartItems, getMemberIdFromJWT());
        } catch (err) {
            console.error(err);
            alert(err.message);
        }
    }

    // ================== 장바구니 렌더링 ==================
    function renderCart(cartItems, memberId) {
        const container = document.getElementById('cart-items');
        container.innerHTML = '';

        if (!cartItems || cartItems.length === 0) {
            container.innerHTML = '<p>장바구니가 비어 있습니다.</p>';
            updatePriceSummary(0);
            return;
        }

        cartItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `
                <input type="checkbox" class="item-select" data-cart-id="${item.id}" />
                <img src="${item.productThumbnailUrl || '/images/default-product.png'}"
                     alt="${item.productName}" class="product-img" />
                <div class="product-info">
                  <strong>${item.productName}</strong><br />
                  <small>사이즈: ${item.size || '-'}</small><br />
                </div>
                <div class="price-info">
                  <span class="original-price" style="text-decoration: line-through; color: gray;">
                    ${Number(item.originalPrice).toLocaleString()}원
                  </span><br />
                  <span class="discount-rate" style="color: orange;">
                    ${item.discountRate}% 할인
                  </span><br />
                  <span class="final-price" style="color:red;font-weight:bold;">
                    ${Number(item.finalPrice).toLocaleString()}원
                  </span><br/>
                  <input type="number" min="1" value="${item.quantity}"
                    onchange="updateCount(${item.id}, this.value)" />
                  <button onclick="deleteCartItem(${item.id})">삭제</button><br/>
                  <span class="total-price">
                    총액: ${Number(item.totalPrice).toLocaleString()}원
                  </span>
                </div>
            `;
            container.appendChild(div);
        });

        document.getElementById('order-now').onclick = () => handleOrderNow(memberId);

        calculatePrice();
    }

    // ================== 수량 변경 ==================
    function updateCount(cartId, newCount) {
        if (newCount < 1) {
            alert('수량은 1 이상이어야 합니다.');
            fetchCartItems();
            return;
        }
        fetch(`/api/v1/cart/${cartId}`, withAuth({
            method: 'PUT',
            body: JSON.stringify({ quantity: parseInt(newCount, 10) })
        }))
        .then(res => handleJson(res))
        .then(() => fetchCartItems())
        .catch(err => { alert(err.message); fetchCartItems(); });
    }

    // ================== 바로 주문 ==================
    function handleOrderNow(memberId) {
        const selectedItems = [...document.querySelectorAll('.item-select:checked')];
        if (selectedItems.length === 0) return alert("선택된 상품이 없습니다.");
        if (!memberId) {
            alert("로그인이 필요합니다.");
            location.href = '/login';
            return;
        }

        const cartIds = selectedItems.map(cb => parseInt(cb.dataset.cartId));
        const totalPrice = selectedItems.reduce((sum, cb) => {
            const itemDiv = cb.closest('.cart-item');
            const totalText = itemDiv.querySelector('.total-price').textContent.replace(/[^0-9]/g,'');
            return sum + parseInt(totalText, 10);
        }, 0);
        const deliveryFee = totalPrice >= 50000 ? 0 : 5000;

        const productNames = selectedItems.map(cb => cb.closest('.cart-item').querySelector('.product-info strong').textContent);
        const productSizes = selectedItems.map(cb => cb.closest('.cart-item').querySelector('.product-info small').textContent.replace('사이즈: ', ''));
        const productImages = selectedItems.map(cb => cb.closest('.cart-item').querySelector('.product-img').src);
        const productQuantities = selectedItems.map(cb => parseInt(cb.closest('.cart-item').querySelector('input[type="number"]').value, 10));

        const orderDto = {
            memberId,
            cartIds,
            totalPrice: totalPrice + deliveryFee,
            postCode: '',
            address: '',
            detailAddress: '',
            ordererName: '',
            phoneNumber: '',
            payMethod: null,
            merchantUid: null,
            productNames,
            productSizes,
            productImages,
            productQuantities
        };

        sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
        window.location.href = "/tempOrder.html";
    }

    // ================== 삭제 / 선택삭제 / 전체선택 ==================
    function deleteCartItem(cartId) {
        if (!confirm('삭제하시겠습니까?')) return;

        fetch(`/api/v1/cart/${cartId}`, withAuth({ method: 'DELETE' }))
            .then(res => { if (!res.ok) throw new Error('삭제 실패'); return res.text(); })
            .then(() => fetchCartItems())
            .catch(err => err && alert(err.message));
    }

    document.getElementById('delete-selected').addEventListener('click', () => {
        const selected = [...document.querySelectorAll('.item-select:checked')];
        if (selected.length === 0) return alert("선택된 상품이 없습니다.");
        if (!confirm(`${selected.length}건을 삭제하시겠습니까?`)) return;

        Promise.all(selected.map(cb => {
            const cartId = cb.dataset.cartId;
            return fetch(`/api/v1/cart/${cartId}`, withAuth({ method: 'DELETE' }))
                .then(res => { if (!res.ok) throw new Error('삭제 실패'); });
        }))
        .then(() => fetchCartItems())
        .catch(() => alert('삭제 실패'));
    });

    document.getElementById('select-all').addEventListener('change', function () {
        const checked = this.checked;
        document.querySelectorAll('.item-select').forEach(cb => cb.checked = checked);
    });

    // ================== 가격 계산 ==================
    function calculatePrice() {
        const items = document.querySelectorAll('.cart-item');
        let totalPrice = 0;
        items.forEach(item => {
            const totalText = item.querySelector('.total-price').textContent.replace(/[^0-9.]/g, '');
            totalPrice += parseFloat(totalText);
        });
        updatePriceSummary(totalPrice);
    }

    function updatePriceSummary(totalPrice) {
        const deliveryFee = totalPrice >= 50000 ? 0 : 5000;
        document.getElementById('total-price').textContent = totalPrice.toLocaleString() + '원';
        document.getElementById('delivery-fee').textContent = deliveryFee.toLocaleString() + '원';
        document.getElementById('total-payment').textContent = (totalPrice + deliveryFee).toLocaleString() + '원';
    }

    fetchCartItems();
</script>
</body>
</html>
