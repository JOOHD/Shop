<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
</html><!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>결제</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
  <h2 class="mb-4">결제 진행</h2>
  <button id="payBtn" class="btn btn-success">결제하기</button>
</div>

<script>
    // 아임포트 초기화
    const IMP = window.IMP;
    IMP.init("impXXXXXXXX"); // 👉 본인의 가맹점 식별코드로 대체하세요

    const orderDto = JSON.parse(sessionStorage.getItem("orderDto"));
    const merchantUid = 'merchant_' + crypto.randomUUID(); // UUID 생성

    document.getElementById("payBtn").addEventListener("click", function () {
        if (!orderDto) {
            alert("주문 정보가 없습니다.");
            return;
        }

        IMP.request_pay({
            pg: getPg(orderDto.payMethod),      // 결제 수단에 따른 PG사 설정
            pay_method: "card",
            merchant_uid: merchantUid,
            name: "장바구니 상품 결제",
            amount: 100, // ✅ 실제 가격을 서버에서 받아오는 것이 안전
            buyer_name: orderDto.ordererName,
            buyer_tel: orderDto.phoneNumber,
            buyer_addr: orderDto.address + " " + (orderDto.detailAddress || ""),
            buyer_postcode: orderDto.postCode
        }, function (rsp) {
            if (rsp.success) {
                // 결제 성공 → 서버에 결제 정보 전송
                fetch("/api/v1/payment/verify", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        impUid: rsp.imp_uid,
                        merchantUid: rsp.merchant_uid,
                        orderDto: orderDto
                    })
                })
                .then(res => res.json())
                .then(data => {
                    alert("결제 완료! 주문번호: " + data.orderId);
                    sessionStorage.removeItem("orderDto");
                    window.location.href = "/order-complete.html";
                })
                .catch(err => {
                    console.error(err);
                    alert("결제 검증 실패. 관리자에게 문의하세요.");
                });
            } else {
                alert("결제가 취소되었습니다. 사유: " + rsp.error_msg);
            }
        });
    });

    function getPg(payMethod) {
        switch (payMethod) {
            case "KAKAO":
                return "kakaopay.TC0ONETIME";
            case "NAVERPAY":
                return "naverpay";
            case "CARD":
            default:
                return "html5_inicis";
        }
    }
</script>
</body>
</html>
