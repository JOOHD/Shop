<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>결제</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
    <h2 class="mb-4">결제 진행</h2>

    <div id="orderInfo" class="mb-4"></div>

    <button id="payBtn" class="btn btn-success">결제하기</button>
</div>

<script>
    // 아임포트 초기화 (가맹점 식별코드는 실제 본인 것으로 교체하세요)
    const IMP = window.IMP;
    IMP.init("impXXXXXXXX"); // TODO: 실제 가맹점 식별코드로 교체

    // 세션에서 주문 정보 가져오기
    const orderDto = JSON.parse(sessionStorage.getItem("orderDto"));

    // 주문 정보가 없으면 경고 후 초기 주문 페이지로 이동
    if (!orderDto) {
      alert("주문 정보가 없습니다. 처음부터 다시 시도해 주세요.");
      window.location.href = "/order.html";
    }

    // 주문 정보를 페이지에 표시
    const orderInfoDiv = document.getElementById("orderInfo");
    orderInfoDiv.innerHTML = `
      <ul class="list-group">
        <li class="list-group-item"><strong>주문자명:</strong> ${orderDto.ordererName}</li>
        <li class="list-group-item"><strong>전화번호:</strong> ${orderDto.phoneNumber}</li>
        <li class="list-group-item"><strong>주소:</strong> (${orderDto.postCode}) ${orderDto.address} ${orderDto.detailAddress || ""}</li>
        <li class="list-group-item"><strong>결제 수단:</strong> ${orderDto.payMethod}</li>
        <li class="list-group-item"><strong>총 결제 금액:</strong> ${orderDto.totalPrice?.toLocaleString()}원</li>
      </ul>
    `;

    const payBtn = document.getElementById("payBtn");
    let isPaying = false; // 이중 클릭 방지용 플래그

    payBtn.addEventListener("click", function () {
      if (isPaying) return; // 이미 결제 진행 중이면 무시
      isPaying = true;
      payBtn.disabled = true;
      payBtn.textContent = "결제 진행 중...";

      // 실제 결제 금액은 서버 검증 후 결정하는 것이 원칙이나, 여기서는 임시로 orderDto에서 사용
      const amount = orderDto.totalPrice || 100;

      console.log("결제 수단:", orderDto.payMethod);
      console.log("PG사 코드:", getPg(orderDto.payMethod));
      console.log("pay_method:", getPayMethod(orderDto.payMethod));
      console.log("결제 금액:", amount);

      IMP.request_pay(
        {
          pg: getPg(orderDto.payMethod),
          pay_method: getPayMethod(orderDto.payMethod),
          merchant_uid: "merchant_" + crypto.randomUUID(),
          name: "장바구니 상품 결제",
          amount: amount,
          buyer_name: orderDto.ordererName,
          buyer_tel: orderDto.phoneNumber,
          buyer_addr: `${orderDto.address ?? ""} ${orderDto.detailAddress ?? ""}`.trim(),
          buyer_postcode: orderDto.postCode,
        },
        function (rsp) {
          if (rsp.success) {
            // 결제 성공 시 서버 검증 API 호출
            fetch("/api/v1/payment/verify", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                impUid: rsp.imp_uid,
                merchantUid: rsp.merchant_uid,
                orderDto: orderDto,
              }),
            })
              .then((res) => res.json())
              .then((data) => {
                alert("결제 완료! 주문번호: " + data.orderId);
                sessionStorage.removeItem("orderDto");
                window.location.href = "/";
              })
              .catch((err) => {
                console.error(err);
                alert("결제 검증 실패. 관리자에게 문의하세요.");
                resetPayButton();
              });
          } else {
            alert("결제가 취소되었습니다. 사유: " + rsp.error_msg);
            resetPayButton();
          }
        }
      );
    });

    // PG사 선택 함수
    function getPg(payMethod) {
      switch (payMethod) {
        case "KAKAO":
          return "kakaopay.TC0ONETIME";
        case "NAVERPAY":
          return "naverpay";
        case "CARD":
        default:
          return "html5_inicis";
      }
    }

    // 결제 수단 매핑 (필요시 확장)
    function getPayMethod(payMethod) {
      switch (payMethod) {
        case "KAKAO":
          return "card"; // 카카오페이도 카드 결제로 요청 (상황에 따라 다름)
        case "NAVERPAY":
          return "naverpay";
        case "CARD":
        default:
          return "card";
      }
    }

    // 결제 버튼 상태 초기화
    function resetPayButton() {
      isPaying = false;
      payBtn.disabled = false;
      payBtn.textContent = "결제하기";
    }
  </script>
</body>
</html>
