<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
</html><!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê²°ì œ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
  <h2 class="mb-4">ê²°ì œ ì§„í–‰</h2>
  <button id="payBtn" class="btn btn-success">ê²°ì œí•˜ê¸°</button>
</div>

<script>
    // ì•„ì„í¬íŠ¸ ì´ˆê¸°í™”
    const IMP = window.IMP;
    IMP.init("impXXXXXXXX"); // ğŸ‘‰ ë³¸ì¸ì˜ ê°€ë§¹ì  ì‹ë³„ì½”ë“œë¡œ ëŒ€ì²´í•˜ì„¸ìš”

    const orderDto = JSON.parse(sessionStorage.getItem("orderDto"));
    const merchantUid = 'merchant_' + crypto.randomUUID(); // UUID ìƒì„±

    document.getElementById("payBtn").addEventListener("click", function () {
        if (!orderDto) {
            alert("ì£¼ë¬¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        IMP.request_pay({
            pg: getPg(orderDto.payMethod),      // ê²°ì œ ìˆ˜ë‹¨ì— ë”°ë¥¸ PGì‚¬ ì„¤ì •
            pay_method: "card",
            merchant_uid: merchantUid,
            name: "ì¥ë°”êµ¬ë‹ˆ ìƒí’ˆ ê²°ì œ",
            amount: 100, // âœ… ì‹¤ì œ ê°€ê²©ì„ ì„œë²„ì—ì„œ ë°›ì•„ì˜¤ëŠ” ê²ƒì´ ì•ˆì „
            buyer_name: orderDto.ordererName,
            buyer_tel: orderDto.phoneNumber,
            buyer_addr: orderDto.address + " " + (orderDto.detailAddress || ""),
            buyer_postcode: orderDto.postCode
        }, function (rsp) {
            if (rsp.success) {
                // ê²°ì œ ì„±ê³µ â†’ ì„œë²„ì— ê²°ì œ ì •ë³´ ì „ì†¡
                fetch("/api/v1/payment/verify", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        impUid: rsp.imp_uid,
                        merchantUid: rsp.merchant_uid,
                        orderDto: orderDto
                    })
                })
                .then(res => res.json())
                .then(data => {
                    alert("ê²°ì œ ì™„ë£Œ! ì£¼ë¬¸ë²ˆí˜¸: " + data.orderId);
                    sessionStorage.removeItem("orderDto");
                    window.location.href = "/order-complete.html";
                })
                .catch(err => {
                    console.error(err);
                    alert("ê²°ì œ ê²€ì¦ ì‹¤íŒ¨. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                });
            } else {
                alert("ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : " + rsp.error_msg);
            }
        });
    });

    function getPg(payMethod) {
        switch (payMethod) {
            case "KAKAO":
                return "kakaopay.TC0ONETIME";
            case "NAVERPAY":
                return "naverpay";
            case "CARD":
            default:
                return "html5_inicis";
        }
    }
</script>
</body>
</html>
