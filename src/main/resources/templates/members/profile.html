<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>회원 프로필</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" th:href="@{/css/profile.css}" />
</head>
<body>
<div class="profile-container">
    <h2>내 프로필</h2>

    <div class="profile-header">
        <img id="profileImage" th:src="@{/images/default_profile.png}" alt="프로필 이미지" class="profile-img" />
        <div class="profile-actions">
            <input type="file" id="imageUpload" accept="image/*" />
            <button id="uploadBtn">프로필 이미지 업로드</button>
        </div>
    </div>

    <div class="profile-info">
        <p><label>닉네임: </label>
            <input type="text" id="nickname" th:value="${member.info.nickname}" />
        </p>
        <p><label>이메일: </label> <span id="email" th:text="${member.info.email}"></span></p>
        <p><label>성별: </label>
            <select id="genderSelect" th:value="${member.memberGender}">
                <option value="">선택</option>
                <option value="MALE">남성</option>
                <option value="FEMALE">여성</option>
            </select>
        </p>
        <p><label>연령대: </label>
            <select id="ageSelect" th:value="${member.memberAges}">
                <option value="">선택</option>
                <option value="TEENS">10대</option>
                <option value="TWENTIES">20대</option>
                <option value="THIRTIES">30대</option>
                <option value="FORTIES">40대</option>
                <option value="FIFTIES">50대 이상</option>
            </select>
        </p>
        <p><label>자기소개:</label></p>
        <textarea id="introduction" rows="4" cols="60" readonly th:text="${member.introduction}"></textarea>

        <!-- 프로필 수정 버튼 하나만 -->
        <button id="updateProfileBtn">프로필 수정</button>
    </div>
</div>

<script th:inline="javascript">
    const memberId = 1;
    const apiBase = `/api/v1/profile/${memberId}`;

    const profileImage = document.getElementById('profileImage');
    const imageUpload = document.getElementById('imageUpload');
    const uploadBtn = document.getElementById('uploadBtn');
    const nicknameInput = document.getElementById('nickname');
    const genderSelect = document.getElementById('genderSelect');
    const ageSelect = document.getElementById('ageSelect');
    const introductionTextarea = document.getElementById('introduction');
    const updateProfileBtn = document.getElementById('updateProfileBtn');

    function loadProfile() {
        fetch(apiBase)
            .then(res => res.ok ? res.json() : Promise.reject('프로필을 불러올 수 없습니다.'))
            .then(data => {
                nicknameInput.value = data.member.nickname || '';
                genderSelect.value = data.memberGender || '';
                ageSelect.value = data.memberAges || '';
                introductionTextarea.value = data.introduction || '';

                fetch(`${apiBase}/image`)
                    .then(imgRes => imgRes.ok ? imgRes.blob() : Promise.reject())
                    .then(blob => profileImage.src = URL.createObjectURL(blob))
                    .catch(() => profileImage.src = '/images/default_profile.png');
            })
            .catch(err => console.error(err));
    }

    // 프로필 수정 버튼 클릭 시 한 번에 업데이트
    updateProfileBtn.addEventListener('click', () => {
        const payload = {
            nickname: nicknameInput.value.trim(),
            gender: genderSelect.value,
            age: ageSelect.value
        };

        if(!payload.nickname) { alert('닉네임을 입력하세요.'); return; }
        if(!payload.gender) { alert('성별을 선택하세요.'); return; }
        if(!payload.age) { alert('연령대를 선택하세요.'); return; }

        fetch(apiBase, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.ok ? alert('프로필이 수정되었습니다.') : alert('프로필 수정 실패'))
        .then(() => loadProfile())
        .catch(() => alert('수정 중 오류 발생'));
    });

    // 프로필 이미지 업로드
    uploadBtn.addEventListener('click', () => {
        const file = imageUpload.files[0];
        if (!file) { alert('업로드할 이미지를 선택하세요.'); return; }
        const formData = new FormData();
        formData.append('imageFile', file);

        fetch(apiBase + '/image/' + memberId, { method: 'POST', body: formData })
            .then(res => res.ok ? (alert('이미지 업로드 완료'), loadProfile()) : alert('이미지 업로드 실패'))
            .catch(() => alert('이미지 업로드 중 오류 발생'));
    });

    window.addEventListener('DOMContentLoaded', loadProfile);
</script>
</body>
</html>
