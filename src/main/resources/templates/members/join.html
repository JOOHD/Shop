<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원 가입</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">회원 가입</h2>
    <form id="joinForm">

        <!-- 이메일 입력 -->
        <div class="form-group">
            <label for="email">이메일</label>
            <div class="input-group">
                <input type="email" class="form-control" id="email" placeholder="이메일을 입력하세요" required>
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" onclick="requestEmailVerification()">인증</button>
                </div>
            </div>
            <small id="emailVerifiedMessage" class="form-text text-success d-none mt-1">
                이메일 인증이 완료되었습니다.
            </small>
        </div>

        <!-- 기본 정보 입력 -->
        <div class="form-group">
            <label for="username">이름</label>
            <input type="text" class="form-control" id="username" placeholder="이름을 입력하세요" required>
        </div>

        <div class="form-group">
            <label for="nickname">닉네임</label>
            <input type="text" class="form-control" id="nickname" placeholder="닉네임을 입력하세요" required>
        </div>

        <div class="form-group">
            <label for="phone">전화번호</label>
            <input type="tel" class="form-control" id="phone" placeholder="예: 010-1234-5678" required>
        </div>

        <div class="form-group">
            <label for="password1">비밀번호</label>
            <input type="password" class="form-control" id="password1" placeholder="비밀번호를 입력하세요" required>
        </div>

        <div class="form-group">
            <label for="password2">비밀번호 확인</label>
            <input type="password" class="form-control" id="password2" placeholder="비밀번호를 다시 입력하세요" required>
        </div>

        <!-- 주소 입력 -->
        <div class="form-group">
            <label for="postCode">우편번호</label>
            <div class="input-group">
                <input type="text" class="form-control" id="postCode" placeholder="우편번호" readonly required>
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" onclick="execDaumPostcode()">주소찾기</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="address">주소</label>
            <input type="text" class="form-control" id="address" placeholder="주소" readonly required>
        </div>

        <div class="form-group">
            <label for="detailAddress">상세 주소</label>
            <input type="text" class="form-control" id="detailAddress" placeholder="상세 주소">
        </div>

        <!-- 가입 버튼 -->
        <div class="d-flex">
            <button type="button" class="btn btn-primary mr-2" onclick="submitJoin(false)">일반 회원 가입</button>
            <button type="button" class="btn btn-danger" onclick="submitJoin(true)">관리자 가입</button>
        </div>
    </form>
</div>

<script>
  function execDaumPostcode() {
    new daum.Postcode({
      oncomplete: function(data) {
        document.getElementById("postCode").value = data.zonecode;
        document.getElementById("address").value = data.roadAddress || data.jibunAddress;
        document.getElementById("detailAddress").focus();
      }
    }).open();
  }

  async function requestEmailVerification() {
    const email = document.getElementById("email").value.trim();
    if (!email) return alert("이메일을 입력하세요.");

    try {
      const res = await fetch('/api/email/verify-request', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      res.ok ? alert("인증 메일 발송 완료.") : alert("실패: " + await res.text());
    } catch (err) {
      alert("오류 발생");
      console.error(err);
    }
  }

  async function checkEmailVerified(email) {
    try {
      const res = await fetch(`/api/email/verify-check?email=${encodeURIComponent(email)}`);
      const data = await res.json();
      return data.verified === true;
    } catch (err) {
      console.error(err);
      return false;
    }
  }

  function showEmailVerifiedMessage() {
    document.getElementById("emailVerifiedMessage").classList.remove("d-none");
  }

  async function submitJoin(isAdmin) {
    const values = ["email", "username", "nickname", "phone", "password1", "password2", "postCode", "address"];
    const data = {};
    for (let id of values) {
      const val = document.getElementById(id).value.trim();
      if (!val) return alert("모든 항목을 입력하세요.");
      data[id] = val;
    }
    data.detailAddress = document.getElementById("detailAddress").value.trim();

    if (data.password1 !== data.password2) return alert("비밀번호 불일치");

    if (!(await checkEmailVerified(data.email))) return alert("이메일 인증 필요");
    showEmailVerifiedMessage();

    const payload = {
      email: data.email,
      username: data.username,
      nickname: data.nickname,
      phone: data.phone,
      password1: data.password1,
      password2: data.password2,
      address: {
        postCode: data.postCode,
        address: data.address,
        detailAddress: data.detailAddress,
        addressName: "기본 주소",
        recipient: data.username,
        recipientPhone: data.phone,
        defaultAddress: true
      }
    };

    const url = isAdmin ? "/api/admin/join" : "/api/join";

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (res.status === 201 || res.ok) {
        alert("가입 성공!");
        window.location.href = "/login";
      } else {
        alert("가입 실패: " + await res.text());
      }
    } catch (err) {
      alert("에러 발생: " + err.message);
    }
  }
</script>
</body>
</html>
