<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì„ì‹œ ì£¼ë¬¸ ë‚´ì—­ í™•ì¸</title>
    <link rel="stylesheet" href="/css/tempOrder.css" />
</head>
<body>

<h2>ğŸ“ ì£¼ë¬¸ ë‚´ì—­ í™•ì¸</h2>

<div id="member-info">
    <p>ì£¼ë¬¸ì: <span id="ordererName">-</span></p>
    <p>ì „í™”ë²ˆí˜¸: <span id="phoneNumber">-</span></p>
</div>

<div id="order-items">
    <!-- JSë¡œ ìƒí’ˆ ë Œë”ë§ -->
</div>

<div id="order-summary">
    <p>ì´ ìƒí’ˆê¸ˆì•¡: <span id="totalPrice">0ì›</span></p>
    <p>ë°°ì†¡ë¹„: <span id="deliveryFee">0ì›</span></p>
    <p>ì´ ê²°ì œê¸ˆì•¡: <span id="totalPayment">0ì›</span></p>
</div>

<button id="proceedToOrder">ê²°ì œí•˜ê¸°</button>

<script>
    document.addEventListener("DOMContentLoaded", async () => { // âœ… asyncë¡œ ë³€ê²½
        try {
            // 1ï¸âƒ£ sessionStorageì—ì„œ orderDto ê°€ì ¸ì˜¤ê¸°
            const orderDto = JSON.parse(sessionStorage.getItem('orderDto'));
            if (!orderDto) throw new Error("ì£¼ë¬¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");

            // 2ï¸âƒ£ DBì—ì„œ íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸° (/member-info í˜¸ì¶œ)
            let memberInfo = {};
            try {
                const res = await fetch('/api/v1/members/member-info', { credentials: 'include' });
                if (!res.ok) throw new Error('íšŒì› ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
                memberInfo = await res.json();
            } catch(e) {
                console.warn("DBì—ì„œ íšŒì› ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨, sessionStorage ê°’ ì‚¬ìš©", e);
                memberInfo = {
                    ordererName: orderDto.ordererName || "-",
                    phoneNumber: orderDto.phoneNumber || "-"
                };
            }

            // 3ï¸âƒ£ ì£¼ë¬¸ì ì •ë³´ í‘œì‹œ
            document.getElementById("ordererName").textContent = memberInfo.ordererName;
            document.getElementById("phoneNumber").textContent = memberInfo.phoneNumber;

            // 4ï¸âƒ£ ìƒí’ˆë³„ ë Œë”ë§
            const container = document.getElementById("order-items");
            let html = "";
            if (orderDto.products && orderDto.products.length > 0) {
                orderDto.products.forEach(p => {
                    html += `
                    <div class="order-card">
                        <img src="${p.image || '/img/no-image.png'}" alt="${p.name}" class="order-product-img">
                        <div class="order-card-body">
                            <p class="product-name">${p.name}</p>
                            <p class="product-size">ì‚¬ì´ì¦ˆ: ${p.size}</p>
                            <p class="product-quantity">ìˆ˜ëŸ‰: ${p.quantity}</p>
                            <p class="product-price">ì´ì•¡: ${p.price.toLocaleString()}ì›</p>
                        </div>
                    </div>`;
                });
            } else {
                html = "<p>ì£¼ë¬¸í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            }
            container.innerHTML = html;

            // 5ï¸âƒ£ ì´ ê²°ì œê¸ˆì•¡ í‘œì‹œ
            const deliveryFee = orderDto.totalPrice >= 50000 ? 0 : 5000;
            document.getElementById("totalPrice").textContent = orderDto.totalPrice.toLocaleString() + "ì›";
            document.getElementById("deliveryFee").textContent = deliveryFee.toLocaleString() + "ì›";
            document.getElementById("totalPayment").textContent = (orderDto.totalPrice + deliveryFee).toLocaleString() + "ì›";

            // 6ï¸âƒ£ ê²°ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById("proceedToOrder").addEventListener("click", async () => {
                try {
                    const res = await fetch("/api/v1/order/confirm", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(orderDto),
                        credentials: 'include'
                    });
                    if (!res.ok) throw new Error("ì£¼ë¬¸ í™•ì • ì‹¤íŒ¨");

                    alert("ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    sessionStorage.removeItem('orderDto');
                    window.location.href = "/orders/confirmation";
                } catch(e) {
                    alert(e);
                }
            });

        } catch (e) {
            alert(e);
        }
    });
</script>

</body>
</html>
