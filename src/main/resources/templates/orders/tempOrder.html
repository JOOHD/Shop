<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì„ì‹œ ì£¼ë¬¸ ë‚´ì—­ í™•ì¸</title>
    <link rel="stylesheet" href="/css/tempOrder.css" />
</head>
<body>

<h2>ğŸ“ ì£¼ë¬¸ ë‚´ì—­ í™•ì¸</h2>

<div id="member-info">
    <p>ì£¼ë¬¸ì: <span id="ordererName">-</span></p>
    <p>ì „í™”ë²ˆí˜¸: <span id="phoneNumber">-</span></p>
</div>

<div id="order-items">
    <!-- JSë¡œ ìƒí’ˆ ë Œë”ë§ -->
</div>

<div id="order-summary">
    <p>ì´ ìƒí’ˆê¸ˆì•¡: <span id="totalPrice">0ì›</span></p>
    <p>ë°°ì†¡ë¹„: <span id="deliveryFee">0ì›</span></p>
    <p>ì´ ê²°ì œê¸ˆì•¡: <span id="totalPayment">0ì›</span></p>
</div>

<button id="proceedToOrder">ê²°ì œí•˜ê¸°</button>

<script>
    <script>
document.addEventListener("DOMContentLoaded", async () => {
    try {
        // 1ï¸âƒ£ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (JWT ê¸°ë°˜)
        const memberRes = await fetch("/api/v1/members/me", {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        });
        if (!memberRes.ok) throw new Error("íšŒì› ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        const memberInfo = await memberRes.json();
        const memberId = memberInfo.id;

        // 2ï¸âƒ£ Redisì—ì„œ ì„ì‹œ ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
        const tempRes = await fetch(`/api/v1/order/temp/${memberId}`, {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        });
        if (!tempRes.ok) throw new Error("ì„ì‹œ ì£¼ë¬¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        const tempOrder = await tempRes.json();

        // 3ï¸âƒ£ ì£¼ë¬¸ì + ì „í™”ë²ˆí˜¸ í‘œì‹œ
        document.getElementById("ordererName").textContent = tempOrder.ordererName || "-";
        document.getElementById("phoneNumber").textContent = tempOrder.phoneNumber || "-";

        // 4ï¸âƒ£ ìƒí’ˆë³„ ë Œë”ë§
        const container = document.getElementById("order-items");
        let html = "";
        tempOrder.productNames.forEach((name, idx) => {
            const size = tempOrder.productSizes[idx];
            const img = tempOrder.productImages[idx];
            const quantity = tempOrder.productQuantities[idx];
            html += `
            <div class="order-card">
                <img src="${img}" alt="${name}" class="order-product-img">
                <div class="order-card-body">
                    <p class="product-name">${name}</p>
                    <p class="product-size">ì‚¬ì´ì¦ˆ: ${size}</p>
                    <p class="product-quantity">ìˆ˜ëŸ‰: ${quantity}</p>
                </div>
            </div>`;
        });
        container.innerHTML = html;

        // 5ï¸âƒ£ ì´ ê²°ì œê¸ˆì•¡ í‘œì‹œ
        const deliveryFee = tempOrder.totalPrice >= 50000 ? 0 : 5000; // ì˜ˆ: 5ë§Œì› ì´ìƒ ë¬´ë£Œë°°ì†¡
        document.getElementById("totalPrice").textContent = tempOrder.totalPrice.toLocaleString() + "ì›";
        document.getElementById("deliveryFee").textContent = deliveryFee.toLocaleString() + "ì›";
        document.getElementById("totalPayment").textContent = (tempOrder.totalPrice + deliveryFee).toLocaleString() + "ì›";

        // 6ï¸âƒ£ ê²°ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById("proceedToOrder").addEventListener("click", async () => {
            try {
                // ì„œë²„ë¡œ ë³´ë‚¼ OrderDto ìƒì„±
                const orderDto = {
                    memberId: tempOrder.memberId,
                    ordererName: tempOrder.ordererName,
                    phoneNumber: tempOrder.phoneNumber,
                    cartIds: tempOrder.cartIds,
                    postCode: "",      // í•„ìš”ì‹œ í”„ë¡ íŠ¸ì—ì„œ ì…ë ¥
                    address: "",
                    detailAddress: "",
                    payMethod: "CARD"   // ì˜ˆì‹œ
                };

                // 7ï¸âƒ£ ì£¼ë¬¸ í™•ì • API í˜¸ì¶œ
                const res = await fetch("/api/v1/order/confirm", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(orderDto),
                    credentials: 'include'
                });
                if (!res.ok) throw new Error("ì£¼ë¬¸ í™•ì • ì‹¤íŒ¨");

                alert("ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                window.location.href = "/orders/confirmation";
            } catch(e) {
                alert(e);
            }
        });

    } catch (e) {
        alert(e);
    }
});
</script>

</script>

</body>
</html>
