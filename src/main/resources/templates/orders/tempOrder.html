<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì„ì‹œ ì£¼ë¬¸ ë‚´ì—­ í™•ì¸</title>
    <link rel="stylesheet" href="/css/tempOrder.css" />
</head>
<body>

<h2>ğŸ“ ì£¼ë¬¸ ë‚´ì—­ í™•ì¸</h2>

<div id="member-info">
    <p>ì£¼ë¬¸ì: <span id="ordererName">-</span></p>
    <p>ì „í™”ë²ˆí˜¸: <span id="phoneNumber">-</span></p>
</div>

<div id="order-items">
    <!-- JSë¡œ ìƒí’ˆ ë Œë”ë§ -->
</div>

<div id="order-summary">
    <p>ì´ ìƒí’ˆê¸ˆì•¡: <span id="totalPrice">0ì›</span></p>
    <p>ë°°ì†¡ë¹„: <span id="deliveryFee">0ì›</span></p>
    <p>ì´ ê²°ì œê¸ˆì•¡: <span id="totalPayment">0ì›</span></p>
</div>

<button id="proceedToOrder">ì£¼ë¬¸ ì™„ë£Œ</button>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        
        // âœ… sessionStorageì—ì„œ ì„ì‹œ ì£¼ë¬¸ DTO ê°€ì ¸ì˜¤ê¸°
        // null ì²´í¬ë¡œ ì˜¤ë¥˜ ë°©ì§€
        const tempOrder = JSON.parse(sessionStorage.getItem('orderDto') || '{}');
        if (!tempOrder || !tempOrder.products) {
            alert("ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        
        // âœ… ì£¼ë¬¸ì + ì „í™”ë²ˆí˜¸ í‘œì‹œ
        document.getElementById("ordererName").textContent = tempOrder.ordererName || "-";
        document.getElementById("phoneNumber").textContent = tempOrder.phoneNumber || "-";

        
        // âœ… ìƒí’ˆë³„ ì›ê°€ê²©/í• ì¸ìœ¨/í• ì¸ê¸ˆì•¡/ìµœì¢…ê¸ˆì•¡ í‘œì‹œ
        const container = document.getElementById("order-items");
        let html = "";
        tempOrder.products.forEach(p => {
            html += `
            <div class="order-card">
                <img src="${p.image}" alt="${p.name}" class="order-product-img">
                <div class="order-card-body">
                    <p class="product-name">${p.name}</p>
                    <p class="product-size">ì‚¬ì´ì¦ˆ: ${p.size}</p>
                    <p class="product-quantity">ìˆ˜ëŸ‰: ${p.quantity}</p>
                    <p class="product-price">ì›ê°€ê²©: ${p.originalPrice.toLocaleString()}ì›</p>
                    <p class="product-price">í• ì¸ìœ¨: ${p.discountRate}%</p>
                    <p class="product-price">í• ì¸ê¸ˆì•¡: ${(p.originalPrice-p.finalPrice).toLocaleString()}ì›</p>
                    <p class="product-price">ìµœì¢…ê¸ˆì•¡: ${p.finalPrice.toLocaleString()}ì›</p>
                </div>
            </div>`;
        });
        container.innerHTML = html;

        document.getElementById("totalPrice").textContent = tempOrder.totalPrice.toLocaleString() + "ì›";
        document.getElementById("deliveryFee").textContent = tempOrder.deliveryFee.toLocaleString() + "ì›";
        document.getElementById("totalPayment").textContent = tempOrder.totalPrice.toLocaleString() + "ì›";

        
        // âœ… ì£¼ë¬¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ POST + sessionStorage ì œê±°
        document.getElementById("proceedToOrder").addEventListener("click", async () => {
            try {
                const res = await fetch("/api/orders", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(tempOrder),
                    credentials: 'include'
                });
                if (!res.ok) throw new Error("ì£¼ë¬¸ ì‹¤íŒ¨");
                alert("ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                sessionStorage.removeItem("orderDto");
                window.location.href="/orders/confirmation";
            } catch(e) { alert(e); }
        });
    });
</script>

</body>
</html>
