<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>임시 주문 내역 확인</title>
    <link rel="stylesheet" href="/css/tempOrder.css" />
</head>
<body>

<h2>📝 주문 내역 확인</h2>

<div id="member-info">
    <p>주문자: <span id="ordererName">-</span></p>
    <p>전화번호: <span id="phoneNumber">-</span></p>
</div>

<div id="order-items">
    <!-- JS로 상품 렌더링 -->
</div>

<div id="order-summary">
    <p>총 상품금액: <span id="totalPrice">0원</span></p>
    <p>배송비: <span id="deliveryFee">0원</span></p>
    <p>총 결제금액: <span id="totalPayment">0원</span></p>
</div>

<button id="proceedToOrder">결제하기</button>

<script>
    <script>
document.addEventListener("DOMContentLoaded", async () => {
    try {
        // 1️⃣ 로그인한 사용자 정보 가져오기 (JWT 기반)
        const memberRes = await fetch("/api/v1/members/me", {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        });
        if (!memberRes.ok) throw new Error("회원 정보 불러오기 실패");
        const memberInfo = await memberRes.json();
        const memberId = memberInfo.id;

        // 2️⃣ Redis에서 임시 주문 정보 조회
        const tempRes = await fetch(`/api/v1/order/temp/${memberId}`, {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        });
        if (!tempRes.ok) throw new Error("임시 주문 정보 불러오기 실패");
        const tempOrder = await tempRes.json();

        // 3️⃣ 주문자 + 전화번호 표시
        document.getElementById("ordererName").textContent = tempOrder.ordererName || "-";
        document.getElementById("phoneNumber").textContent = tempOrder.phoneNumber || "-";

        // 4️⃣ 상품별 렌더링
        const container = document.getElementById("order-items");
        let html = "";
        tempOrder.productNames.forEach((name, idx) => {
            const size = tempOrder.productSizes[idx];
            const img = tempOrder.productImages[idx];
            const quantity = tempOrder.productQuantities[idx];
            html += `
            <div class="order-card">
                <img src="${img}" alt="${name}" class="order-product-img">
                <div class="order-card-body">
                    <p class="product-name">${name}</p>
                    <p class="product-size">사이즈: ${size}</p>
                    <p class="product-quantity">수량: ${quantity}</p>
                </div>
            </div>`;
        });
        container.innerHTML = html;

        // 5️⃣ 총 결제금액 표시
        const deliveryFee = tempOrder.totalPrice >= 50000 ? 0 : 5000; // 예: 5만원 이상 무료배송
        document.getElementById("totalPrice").textContent = tempOrder.totalPrice.toLocaleString() + "원";
        document.getElementById("deliveryFee").textContent = deliveryFee.toLocaleString() + "원";
        document.getElementById("totalPayment").textContent = (tempOrder.totalPrice + deliveryFee).toLocaleString() + "원";

        // 6️⃣ 결제 버튼 클릭 이벤트
        document.getElementById("proceedToOrder").addEventListener("click", async () => {
            try {
                // 서버로 보낼 OrderDto 생성
                const orderDto = {
                    memberId: tempOrder.memberId,
                    ordererName: tempOrder.ordererName,
                    phoneNumber: tempOrder.phoneNumber,
                    cartIds: tempOrder.cartIds,
                    postCode: "",      // 필요시 프론트에서 입력
                    address: "",
                    detailAddress: "",
                    payMethod: "CARD"   // 예시
                };

                // 7️⃣ 주문 확정 API 호출
                const res = await fetch("/api/v1/order/confirm", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(orderDto),
                    credentials: 'include'
                });
                if (!res.ok) throw new Error("주문 확정 실패");

                alert("주문이 완료되었습니다!");
                window.location.href = "/orders/confirmation";
            } catch(e) {
                alert(e);
            }
        });

    } catch (e) {
        alert(e);
    }
});
</script>

</script>

</body>
</html>
