<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>임시 주문 내역 확인</title>
    <link rel="stylesheet" href="/css/tempOrder.css" />
</head>
<body>

<h2>📝 주문 내역 확인</h2>

<div id="member-info">
    <p>주문자: <span id="ordererName">-</span></p>
    <p>전화번호: <span id="phoneNumber">-</span></p>
</div>

<div id="order-items">
    <!-- JS로 상품 렌더링 -->
</div>

<div id="order-summary">
    <p>총 상품금액: <span id="totalPrice">0원</span></p>
    <p>배송비: <span id="deliveryFee">0원</span></p>
    <p>총 결제금액: <span id="totalPayment">0원</span></p>
</div>

<button id="proceedToOrder">주문 완료</button>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        
        // ✅ sessionStorage에서 임시 주문 DTO 가져오기
        // null 체크로 오류 방지
        const tempOrder = JSON.parse(sessionStorage.getItem('orderDto') || '{}');
        if (!tempOrder || !tempOrder.products) {
            alert("주문 데이터가 없습니다.");
            return;
        }

        
        // ✅ 주문자 + 전화번호 표시
        document.getElementById("ordererName").textContent = tempOrder.ordererName || "-";
        document.getElementById("phoneNumber").textContent = tempOrder.phoneNumber || "-";

        
        // ✅ 상품별 원가격/할인율/할인금액/최종금액 표시
        const container = document.getElementById("order-items");
        let html = "";
        tempOrder.products.forEach(p => {
            html += `
            <div class="order-card">
                <img src="${p.image}" alt="${p.name}" class="order-product-img">
                <div class="order-card-body">
                    <p class="product-name">${p.name}</p>
                    <p class="product-size">사이즈: ${p.size}</p>
                    <p class="product-quantity">수량: ${p.quantity}</p>
                    <p class="product-price">원가격: ${p.originalPrice.toLocaleString()}원</p>
                    <p class="product-price">할인율: ${p.discountRate}%</p>
                    <p class="product-price">할인금액: ${(p.originalPrice-p.finalPrice).toLocaleString()}원</p>
                    <p class="product-price">최종금액: ${p.finalPrice.toLocaleString()}원</p>
                </div>
            </div>`;
        });
        container.innerHTML = html;

        document.getElementById("totalPrice").textContent = tempOrder.totalPrice.toLocaleString() + "원";
        document.getElementById("deliveryFee").textContent = tempOrder.deliveryFee.toLocaleString() + "원";
        document.getElementById("totalPayment").textContent = tempOrder.totalPrice.toLocaleString() + "원";

        
        // ✅ 주문 버튼 클릭 시 서버 POST + sessionStorage 제거
        document.getElementById("proceedToOrder").addEventListener("click", async () => {
            try {
                const res = await fetch("/api/orders", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(tempOrder),
                    credentials: 'include'
                });
                if (!res.ok) throw new Error("주문 실패");
                alert("주문이 완료되었습니다!");
                sessionStorage.removeItem("orderDto");
                window.location.href="/orders/confirmation";
            } catch(e) { alert(e); }
        });
    });
</script>

</body>
</html>
