<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>임시 주문 내역 확인</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/tempOrder.css">
</head>
<body class="bg-light">
<div class="container mt-5">
    <h2 class="mb-4">임시 주문 내역 확인</h2>
    <div id="orderSummary" class="mb-4"></div>
    <form id="proceedForm" method="get" action="/order">
        <input type="hidden" name="cartIds" id="cartIdsInput" />
        <button type="submit" class="btn btn-primary">결제 진행</button>
    </form>
</div>

<script>
    (async function() {
        const summaryDiv = document.getElementById("orderSummary");

        // 1️⃣ sessionStorage에서 먼저 시도
        let orderDtoStr = sessionStorage.getItem("orderDto");
        let orderDto = orderDtoStr ? JSON.parse(orderDtoStr) : null;

        // 2️⃣ 없으면 서버 API 호출 (Redis)
        if (!orderDto) {
            try {
                const memberId = 1; // TODO: 로그인 사용자 ID로 교체
                const res = await fetch(`/api/v1/order/temp/${memberId}`);
                if (!res.ok) throw new Error("임시 주문 정보 없음");
                orderDto = await res.json();
                console.log(orderDto);
                sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
            } catch(err) {
                console.error(err);
                alert("임시 주문 정보를 가져올 수 없습니다.");
                window.location.href = "/cart";
                return;
            }
        }

        // 3️⃣ 상품 카드 생성
        let cardsHtml = '';
        if(orderDto.productNames && orderDto.productNames.length > 0){
            for(let i=0; i<orderDto.productNames.length; i++){
                const name = orderDto.productNames[i];
                const size = orderDto.productSizes[i] || "-";
                const img = orderDto.productImages[i]
                            ? `<img src="${orderDto.productImages[i]}" alt="${name}" class="img-thumbnail me-2" style="width:50px;">`
                            : '';
                const quantity = orderDto.productQuantities && orderDto.productQuantities[i]
                                 ? orderDto.productQuantities[i]
                                 : 1;
                cardsHtml += `
                    <div class="order-card mb-3 p-3 border rounded d-flex align-items-center">
                        ${img}
                        <div>
                            <div class="product-name"><strong>상품명:</strong> ${name}</div>
                            <div class="product-size"><strong>사이즈:</strong> ${size}</div>
                            <div class="product-quantity"><strong>수량:</strong> ${quantity}</div>
                        </div>
                    </div>
                `;
            }
        }

        // 4️⃣ 구매자 정보
        cardsHtml += `
            <ul class="list-group mt-4 mb-3">
                <li class="list-group-item"><strong>주문자명:</strong> ${orderDto.username || "-"}</li>
                <li class="list-group-item"><strong>전화번호:</strong> ${orderDto.phoneNumber || "-"}</li>
            </ul>
        `;

        // 5️⃣ 총 결제 금액
        cardsHtml += `<div class="total-price fw-bold">총 결제 금액: ${Number(orderDto.totalPrice).toLocaleString()}원</div>`;

        summaryDiv.innerHTML = cardsHtml;

        // 6️⃣ hidden input에 cartIds 주입
        document.getElementById("cartIdsInput").value = orderDto.cartIds.join(",");

        // 7️⃣ 결제 진행 버튼 시 sessionStorage 유지
        document.getElementById("proceedForm").addEventListener("submit", function () {
            sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
        });
    })();
</script>
</body>
</html>
