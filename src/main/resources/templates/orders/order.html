<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주문 및 결제</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/order.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 아임포트 JS -->
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <!-- Daum 주소 API -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
    <h2 class="mb-4">주문 및 결제</h2>

    <!-- 주문 요약 -->
    <div id="orderSummary" class="mb-4"></div>

    <!-- 주문자 / 전화번호 / 주소 -->
    <form id="orderForm">
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="ordererName" class="form-label">주문자명</label>
                <input type="text" class="form-control" id="ordererName" name="ordererName" readonly required>
            </div>
            <div class="col-md-6">
                <label for="phoneNumber" class="form-label">전화번호</label>
                <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" readonly required>
            </div>
        </div>

        <!-- 배송지 선택 -->
        <div class="mb-3">
            <label class="form-label">배송지 선택</label>
            <div class="option-container d-flex gap-3">
                <div id="defaultBox" class="option-box active" data-value="default">기존 주소</div>
                <div id="newBox" class="option-box" data-value="new">새로운 주소 입력</div>
            </div>
        </div>

        <!-- 주소 입력란 -->
        <div class="mb-3">
            <label class="form-label">주소</label>
            <div class="input-group mb-2">
                <input type="text" class="form-control" id="postCode" placeholder="우편번호" readonly required>
                <button type="button" id="findAddressBtn" class="btn btn-outline-secondary" onclick="execDaumPostcode()" disabled>주소찾기</button>
            </div>
            <input type="text" class="form-control mb-2" id="address" placeholder="주소" readonly required>
            <input type="text" class="form-control" id="detailAddress" placeholder="상세주소 입력" required>
        </div>

        <button type="button" id="payBtn" class="btn btn-primary w-100">결제 진행</button>
    </form>
</div>

<script>
    // ====== Daum 주소 찾기 ======
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById('postCode').value = data.zonecode;
                document.getElementById('address').value = data.address;
                document.getElementById('detailAddress').focus();
            }
        }).open();
    }

    (async function(){
        let orderDto = await loadOrderDto(); // 주문 정보 로드
        if(!orderDto) return;

        renderOrderSummary(orderDto);        // 주문 요약 화면 렌더링
        fillBuyerInfo(orderDto);             // 구매자 정보 세팅
        setupAddressBox(orderDto);           // 배송지 선택 박스 이벤트
        setupPaymentButton(orderDto);        // 결제 버튼 이벤트
    })();

    // ====== 주문 정보 로드 ======
    async function loadOrderDto(){
        try {
            let orderDtoStr = sessionStorage.getItem("orderDto");
            let orderDto = orderDtoStr ? JSON.parse(orderDtoStr) : null;

            if(!orderDto){
                const memberId = 1; // TODO: 로그인 사용자 ID
                const res = await fetch(`/api/v1/order/temp/${memberId}`);
                if(!res.ok) throw new Error("임시 주문 정보 없음");
                orderDto = await res.json();
                sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
            }

            return orderDto;
        } catch(err){
            console.error(err);
            alert("임시 주문 정보를 가져올 수 없습니다.");
            window.location.href = "/cart";
            return null;
        }
    }

    // ====== 주문 요약 화면 렌더링 ======
    function renderOrderSummary(orderDto){
        const summaryDiv = document.getElementById("orderSummary");
        let cardsHtml = '';

        if(orderDto.products && orderDto.products.length > 0){
            orderDto.products.forEach(p => {
                const imgTag = p.image
                    ? `<img src="${p.image}" alt="${p.name}" class="img-thumbnail me-3 flex-shrink-0" style="width:180px; height:auto;">`
                    : `<img src="/img/no-image.png" alt="no image" class="img-thumbnail me-3 flex-shrink-0" style="width:180px; height:auto;">`;

                const size = p.size || "-";
                const quantity = p.quantity || 1;
                const original = p.originalPrice || p.price || 0;
                const discountRate = p.discountRate || 0;
                const discountAmount = Math.floor(original * (discountRate / 100));
                const finalPrice = p.price || 0;

                cardsHtml += `
                    <div class="order-card mb-3 p-3 border rounded d-flex">
                        ${imgTag}
                        <div class="flex-grow-1">
                            <div><strong>상품명:</strong> ${p.name}</div>
                            <div><strong>사이즈:</strong> ${size}</div>
                            <div><strong>수량:</strong> ${quantity}</div>
                            <div class="text-muted"><del>원가: ${original.toLocaleString()}원</del></div>
                            <div class="text-danger">할인율: ${discountRate}% (-${discountAmount.toLocaleString()}원)</div>
                            <div class="fw-bold">최종가: ${finalPrice.toLocaleString()}원</div>
                        </div>
                    </div>
                `;
            });
        } else {
            cardsHtml = "<p>주문한 상품이 없습니다.</p>";
        }

        cardsHtml += `<div class="total-price fw-bold mt-3">총 결제 금액: ${Number(orderDto.totalPrice || 0).toLocaleString()}원</div>`;
        summaryDiv.innerHTML = cardsHtml;
    }

    // ====== 구매자 정보 세팅 ======
    function fillBuyerInfo(orderDto){
        document.getElementById("ordererName").value = orderDto.ordererName || orderDto.username || "";
        document.getElementById("phoneNumber").value = orderDto.phoneNumber || "";
        document.getElementById("postCode").value = orderDto.postCode || "";
        document.getElementById("address").value = orderDto.address || "";
        document.getElementById("detailAddress").value = orderDto.detailAddress || "";

        // 기본 배송지 저장
        orderDto.defaultPost = orderDto.postCode || "";
        orderDto.defaultAddr = orderDto.address || "";
        orderDto.defaultDetail = orderDto.detailAddress || "";
    }

    // ====== 배송지 선택 박스 이벤트 ======
    function setupAddressBox(orderDto){
        const defaultBox = document.getElementById("defaultBox");
        const newBox = document.getElementById("newBox");

        function activateBox(selected, other){
            selected.classList.add("active");
            other.classList.remove("active");
        }

        defaultBox.addEventListener("click", () => {
            activateBox(defaultBox, newBox);
            document.getElementById("findAddressBtn").disabled = true;
            document.getElementById("postCode").readOnly = true;
            document.getElementById("address").readOnly = true;
            document.getElementById("postCode").value = orderDto.defaultPost;
            document.getElementById("address").value = orderDto.defaultAddr;
            document.getElementById("detailAddress").value = orderDto.defaultDetail;
        });

        newBox.addEventListener("click", () => {
            activateBox(newBox, defaultBox);
            document.getElementById("findAddressBtn").disabled = false;
            document.getElementById("postCode").readOnly = false;
            document.getElementById("address").readOnly = false;
            document.getElementById("postCode").value = "";
            document.getElementById("address").value = "";
            document.getElementById("detailAddress").value = "";
        });
    }

    // ====== 결제 버튼 이벤트 ======
    function setupPaymentButton(orderDto){
        document.getElementById("payBtn").addEventListener("click", async function(){
            // 배송지 업데이트
            orderDto.postCode = document.getElementById("postCode").value;
            orderDto.address = document.getElementById("address").value;
            orderDto.detailAddress = document.getElementById("detailAddress").value;
            sessionStorage.setItem("orderDto", JSON.stringify(orderDto));

            const IMP = window.IMP;
            IMP.init("imp05078720"); // TODO: 아임포트 가맹점 코드

            IMP.request_pay({
                pg: "html5_inicis",
                merchant_uid: `order_${new Date().getTime()}`,
                name: "주문 상품",
                amount: orderDto.totalPrice || 0,
                buyer_name: orderDto.username || "",
                buyer_tel: orderDto.phoneNumber || "",
                buyer_addr: (orderDto.address || "") + " " + (orderDto.detailAddress || ""),
            }, async function(rsp){
                if(rsp.success){
                    alert("결제가 완료되었습니다.");
                    const paymentData = {
                        memberId: orderDto.memberId,
                        orderId: orderDto.orderId,
                        price: orderDto.totalPrice,
                        inventoryIdList: orderDto.cartIds || [],
                        impUid: rsp.imp_uid,
                    };

                    try{
                        const res = await fetch("/api/v1/payment/" + rsp.imp_uid, {
                            method: "POST",
                            headers: {"Content-Type":"application/json"},
                            body: JSON.stringify(paymentData)
                        });
                        if(!res.ok) throw new Error("서버 결제 처리 실패");

                        alert("결제 내역이 서버에 저장되었습니다.");
                        sessionStorage.removeItem("orderDto");
                        window.location.href = "/order-complete";
                    } catch(err){
                        console.error(err);
                        alert("결제 완료 후 서버 처리 중 오류가 발생했습니다. 고객센터에 문의해주세요.");
                    }
                } else {
                    alert("결제에 실패했습니다. " + (rsp.error_msg || ""));
                }
            });
        });
    }
</script>
</body>
</html>
