<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주문서 작성</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/order.css">
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
    <h2 class="mb-4">주문서 작성</h2>

    <!-- 상품 카드 -->
    <div id="orderSummary" class="mb-4"></div>

    <!-- 주문서 폼 -->
    <form id="orderForm">
        <div class="input-card">
            <label for="ordererName">주문자명</label>
            <input type="text" id="ordererName" required>
        </div>
        <div class="input-card">
            <label for="phoneNumber">전화번호</label>
            <input type="text" id="phoneNumber">
        </div>
        <div class="input-card">
            <label for="postCode">우편번호</label>
            <input type="text" id="postCode" required>
        </div>
        <div class="input-card">
            <label for="address">주소</label>
            <input type="text" id="address" required>
        </div>
        <div class="input-card">
            <label for="detailAddress">상세주소</label>
            <input type="text" id="detailAddress">
        </div>
        <div class="input-card">
            <label for="payMethod">결제 수단</label>
            <select id="payMethod" required>
                <option value="">선택하세요</option>
                <option value="CARD">카드</option>
                <option value="KAKAO">카카오페이</option>
                <option value="NAVERPAY">네이버페이</option>
            </select>
        </div>

        <!-- 읽기 전용 hidden 필드 -->
        <input type="hidden" id="cartIds">
        <input type="hidden" id="totalPrice">

        <button type="submit" class="btn btn-success">결제 화면으로 이동</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const orderDtoStr = sessionStorage.getItem("orderDto");
        if (!orderDtoStr) {
            alert("주문 정보가 없습니다.");
            window.location.href = "/cart";
            return;
        }

        const orderDto = JSON.parse(orderDtoStr);

        // 상품 카드 생성
        const summaryDiv = document.getElementById("orderSummary");
        let cardsHtml = '';
        if(orderDto.products && orderDto.products.length > 0) {
            orderDto.products.forEach(product => {
                cardsHtml += `
                    <div class="order-summary-card mb-3 p-3 border rounded">
                        <div class="card-body">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">${Number(product.price).toLocaleString()}원</div>
                            <div class="product-quantity">수량: ${product.quantity}</div>
                        </div>
                    </div>
                `;
            });
        }
        cardsHtml += `<div class="total-price fw-bold">총 결제 금액: ${Number(orderDto.totalPrice).toLocaleString()}원</div>`;
        summaryDiv.innerHTML = cardsHtml;

        // 폼 초기값 세팅
        document.getElementById("ordererName").value = orderDto.ordererName || "";
        document.getElementById("phoneNumber").value = orderDto.phoneNumber || "";
        document.getElementById("postCode").value = orderDto.postCode || "";
        document.getElementById("address").value = orderDto.address || "";
        document.getElementById("detailAddress").value = orderDto.detailAddress || "";
        document.getElementById("payMethod").value = orderDto.payMethod || "";
        document.getElementById("cartIds").value = orderDto.cartIds.join(",");
        document.getElementById("totalPrice").value = orderDto.totalPrice || 0;
    });

    // 주문서 제출
    document.getElementById("orderForm").addEventListener("submit", function(e) {
        e.preventDefault();

        const orderDto = {
            memberId: 1, // 로그인 사용자 ID
            ordererName: document.getElementById("ordererName").value,
            phoneNumber: document.getElementById("phoneNumber").value,
            postCode: document.getElementById("postCode").value,
            address: document.getElementById("address").value,
            detailAddress: document.getElementById("detailAddress").value,
            payMethod: document.getElementById("payMethod").value,
            cartIds: document.getElementById("cartIds").value.split(',').map(id => parseInt(id.trim())),
            totalPrice: Number(document.getElementById("totalPrice").value)
        };

        fetch("/api/v1/order/create", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(orderDto)
        })
        .then(res => res.text())
        .then(msg => {
            alert("주문서 저장 완료. 결제 화면으로 이동합니다.");
            sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
            window.location.href = "/payment";
        })
        .catch(err => {
            console.error(err);
            alert("주문 생성 중 오류가 발생했습니다.");
        });
    });
</script>
</body>
</html>
