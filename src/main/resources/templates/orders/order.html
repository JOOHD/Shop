<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주문 확인</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/order.css">
</head>
<body class="bg-light">
<div class="container mt-5">
    <h2 class="mb-4">주문 확인</h2>
    <div id="orderSummary" class="mb-4"></div>

    <form id="orderForm">
        <div class="mb-3">
            <label for="ordererName" class="form-label">주문자명</label>
            <input type="text" class="form-control" id="ordererName" name="ordererName">
        </div>
        <div class="mb-3">
            <label for="phoneNumber" class="form-label">전화번호</label>
            <input type="text" class="form-control" id="phoneNumber" name="phoneNumber">
        </div>
        <div class="mb-3">
            <label for="postCode" class="form-label">우편번호</label>
            <input type="text" class="form-control" id="postCode" name="postCode">
        </div>
        <div class="mb-3">
            <label for="address" class="form-label">주소</label>
            <input type="text" class="form-control" id="address" name="address">
        </div>
        <div class="mb-3">
            <label for="detailAddress" class="form-label">상세주소</label>
            <input type="text" class="form-control" id="detailAddress" name="detailAddress">
        </div>
        <div class="mb-3">
            <label class="form-label">결제수단</label>
            <select class="form-select" id="payMethod" name="payMethod">
                <option value="card">신용카드</option>
                <option value="vbank">가상계좌</option>
                <option value="trans">실시간 계좌이체</option>
            </select>
        </div>
        <button type="button" id="payBtn" class="btn btn-primary">결제 진행</button>
    </form>
</div>

<script>
    (async function() {
        const summaryDiv = document.getElementById("orderSummary");

        // 1️⃣ sessionStorage에서 먼저 임시 주문 정보 가져오기
        let orderDtoStr = sessionStorage.getItem("orderDto");
        let orderDto = orderDtoStr ? JSON.parse(orderDtoStr) : null;

        // 2️⃣ 없으면 서버 API 호출 (Redis)
        if(!orderDto){
            try{
                const memberId = 1; // TODO: 로그인 사용자 ID로 교체
                const res = await fetch(`/api/v1/order/temp/${memberId}`);
                if(!res.ok) throw new Error("임시 주문 정보 없음");
                orderDto = await res.json();
                sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
            } catch(err){
                console.error(err);
                alert("임시 주문 정보를 가져올 수 없습니다.");
                window.location.href = "/cart";
                return;
            }
        }

        // 3️⃣ 상품 카드 생성
        let cardsHtml = '';
        if(orderDto.productNames && orderDto.productNames.length > 0){
            for(let i=0; i<orderDto.productNames.length; i++){
                const name = orderDto.productNames[i];
                const size = orderDto.productSizes[i] || "-";
                const img = orderDto.productImages[i]
                            ? `<img src="${orderDto.productImages[i]}" alt="${name}" class="img-thumbnail me-2" style="width:50px;">`
                            : '';
                const quantity = orderDto.cartIds[i] ? 1 : 1; // Redis에는 수량 없으면 1로 표시
                cardsHtml += `
                    <div class="order-card mb-3 p-3 border rounded d-flex align-items-center">
                        ${img}
                        <div>
                            <div class="product-name"><strong>상품명:</strong> ${name}</div>
                            <div class="product-size"><strong>사이즈:</strong> ${size}</div>
                            <div class="product-quantity"><strong>수량:</strong> ${quantity}</div>
                        </div>
                    </div>
                `;
            }
        }

        // 4️⃣ 구매자 정보 기본값 세팅
        document.getElementById("ordererName").value = orderDto.username || "";
        document.getElementById("phoneNumber").value = orderDto.phoneNumber || "";
        document.getElementById("postCode").value = orderDto.postCode || "";
        document.getElementById("address").value = orderDto.address || "";
        document.getElementById("detailAddress").value = orderDto.detailAddress || "";

        // 5️⃣ 총 결제 금액 표시
        cardsHtml += `<div class="total-price fw-bold mt-3">총 결제 금액: ${Number(orderDto.totalPrice).toLocaleString()}원</div>`;
        summaryDiv.innerHTML = cardsHtml;

        // 6️⃣ 결제 버튼 클릭 -> PG 처리로 이동
        document.getElementById("payBtn").addEventListener("click", function(){
            // 결제 페이지(payment)로 필요한 정보 전달
            // 예: sessionStorage에 orderDto 저장 후 payment 페이지 이동
            sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
            window.location.href = "/payment"; // payment 디렉토리 처리
        });

    })();
</script>
</body>
</html>
