<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주문서 작성</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body class="bg-light">
<!-- ================== 적용 포인트 ==================
1. sessionStorage에서 orderDto 불러와 폼에 초기값 세팅
2. 주문서 작성 후 서버 POST → orderDto 재저장
==================================================== -->
<form id="orderForm">
    <input type="text" id="ordererName" required>
    <input type="text" id="phoneNumber">
    <input type="text" id="postCode" required>
    <input type="text" id="address" required>
    <input type="text" id="detailAddress">
    <select id="payMethod" required>
        <option value="">선택하세요</option>
        <option value="CARD">카드</option>
        <option value="KAKAO">카카오페이</option>
        <option value="NAVERPAY">네이버페이</option>
    </select>
    <input type="text" id="cartIds" readonly>
    <input type="number" id="totalPrice" readonly>
    <button type="submit">결제 화면으로 이동</button>
</form>

<script>
    document.addEventListener("DOMContentLoaded", function() {
      const orderDtoStr = sessionStorage.getItem("orderDto");
      if (orderDtoStr) {
        const orderDto = JSON.parse(orderDtoStr);

        // 폼 초기값 세팅
        document.getElementById("ordererName").value = orderDto.ordererName || "";
        document.getElementById("phoneNumber").value = orderDto.phoneNumber || "";
        document.getElementById("postCode").value = orderDto.postCode || "";
        document.getElementById("address").value = orderDto.address || "";
        document.getElementById("detailAddress").value = orderDto.detailAddress || "";
        document.getElementById("payMethod").value = orderDto.payMethod || "";
        document.getElementById("cartIds").value = orderDto.cartIds.join(",");
        document.getElementById("totalPrice").value = orderDto.totalPrice || 0;
      }
    });

    // 주문서 제출
    document.getElementById("orderForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const orderDto = {
        memberId: 1,
        ordererName: document.getElementById("ordererName").value,
        phoneNumber: document.getElementById("phoneNumber").value,
        postCode: document.getElementById("postCode").value,
        address: document.getElementById("address").value,
        detailAddress: document.getElementById("detailAddress").value,
        payMethod: document.getElementById("payMethod").value,
        cartIds: document.getElementById("cartIds").value.split(',').map(id => parseInt(id.trim())),
        totalPrice: Number(document.getElementById("totalPrice").value)
      };

      // 서버에 임시 주문 저장
      fetch("/api/v1/order/create", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(orderDto)
      })
      .then(res => res.text())
      .then(msg => {
        alert("주문서 저장 완료. 결제 화면으로 이동합니다.");
        sessionStorage.setItem("orderDto", JSON.stringify(orderDto)); // 최신 상태 저장
        window.location.href = "/payment";
      })
      .catch(err => {
        console.error(err);
        alert("주문 생성 중 오류가 발생했습니다.");
      });
    });
</script>
</body>
</html>
