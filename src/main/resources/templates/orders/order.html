<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주문 및 결제</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 아임포트 JS -->
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
    <h2 class="mb-4">주문 및 결제</h2>

    <!-- 주문 요약 -->
    <div id="orderSummary" class="mb-4"></div>

    <!-- 주문자 / 전화번호 / 주소 -->
    <form id="orderForm">
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="ordererName" class="form-label">주문자명</label>
                <input type="text" class="form-control" id="ordererName" name="ordererName" required>
            </div>
            <div class="col-md-6">
                <label for="phoneNumber" class="form-label">전화번호</label>
                <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" required>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">주소</label>
            <div class="input-group mb-2">
                <input type="text" class="form-control" id="postCode" placeholder="우편번호" readonly required>
                <button type="button" class="btn btn-outline-secondary" onclick="execDaumPostcode()">주소찾기</button>
            </div>
            <input type="text" class="form-control mb-2" id="address" placeholder="주소" readonly required>
            <input type="text" class="form-control" id="detailAddress" placeholder="상세주소 입력" required>
        </div>

        <div class="mb-3">
            <label class="form-label">결제수단</label>
            <select class="form-select" id="payMethod" name="payMethod">
                <option value="card">신용카드</option>
                <option value="vbank">가상계좌</option>
                <option value="trans">실시간 계좌이체</option>
            </select>
        </div>

        <button type="button" id="payBtn" class="btn btn-primary w-100">결제 진행</button>
    </form>
</div>

<script>
    // ====== Daum 주소 찾기 ======
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById('postCode').value = data.zonecode;
                document.getElementById('address').value = data.address;
                document.getElementById('detailAddress').focus();
            }
        }).open();
    }

    // ====== 주문 정보 로드 + 결제 처리 ======
    (async function() {
        const summaryDiv = document.getElementById("orderSummary");

        // 1️⃣ sessionStorage에서 임시 주문 정보 가져오기
        let orderDtoStr = sessionStorage.getItem("orderDto");
        let orderDto = orderDtoStr ? JSON.parse(orderDtoStr) : null;

        // 2️⃣ 없으면 서버 API 호출
        if(!orderDto){
            try{
                const memberId = 1; // TODO: 로그인 사용자 ID
                const res = await fetch(`/api/v1/order/temp/${memberId}`);
                if(!res.ok) throw new Error("임시 주문 정보 없음");
                orderDto = await res.json();
                sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
            } catch(err){
                console.error(err);
                alert("임시 주문 정보를 가져올 수 없습니다.");
                window.location.href = "/cart";
                return;
            }
        }

        // 3️⃣ 상품 카드 생성
        let cardsHtml = '';
        if(orderDto.products && orderDto.products.length > 0){
                const imgTag = p.image ? `<img src="${p.image}" alt="${p.name}" class="img-thumbnail me-2" style="width:50px;">`
                                : `<img src="/img/no-image.png" alt="no image" class="img-thumbnail me-2" style="width:50px;">`;
                const size = p.size || "-";
                const quantity = p.quantity || 1;
                const price = p.price || 0;

                cardsHtml += `
                <div class="order-card mb-3 p-3 border rounded d-flex align-items-center">
                    ${imgTag}
                    <div>
                        <div><strong>상품명:</strong> ${p.name}</div>
                        <div><strong>사이즈:</strong> ${size}</div>
                        <div><strong>수량:</strong> ${quantity}</div>
                        <div><strong>총액:</strong> ${price.toLocaleString()}원</div>
                    </div>
                </div>
            `;
        });
    } else {
        cardsHtml = "<p>주문한 상품이 없습니다.</p>";
    }
    summaryDiv.innerHTML = cardsHtml;

        // 4️⃣ 구매자 정보 세팅
        document.getElementById("ordererName").value = orderDto.ordererName || orderDto.username || "";
        document.getElementById("phoneNumber").value = orderDto.phoneNumber || "";
        document.getElementById("postCode").value = orderDto.postCode || "";
        document.getElementById("address").value = orderDto.address || "";
        document.getElementById("detailAddress").value = orderDto.detailAddress || "";

        // 5️⃣ 총 결제 금액 표시
        cardsHtml += `<div class="total-price fw-bold mt-3">총 결제 금액: ${Number(orderDto.totalPrice).toLocaleString()}원</div>`;
        summaryDiv.innerHTML = cardsHtml;

        // 6️⃣ 결제 버튼 클릭 -> PG 처리
        document.getElementById("payBtn").addEventListener("click", function(){
            // 상세 주소 포함 주문Dto 업데이트
            orderDto.postCode = document.getElementById("postCode").value;
            orderDto.address = document.getElementById("address").value;
            orderDto.detailAddress = document.getElementById("detailAddress").value;
            orderDto.payMethod = document.getElementById("payMethod").value;

            sessionStorage.setItem("orderDto", JSON.stringify(orderDto));

            // 아임포트 결제 요청
            const IMP = window.IMP;
            IMP.init("imp05078720"); // TODO: 아임포트 가맹점 코드
            IMP.request_pay({
                pg: "html5_inicis",
                pay_method: orderDto.payMethod,
                merchant_uid: `order_${new Date().getTime()}`,
                name: "주문 상품",
                amount: orderDto.totalPrice,
                buyer_name: orderDto.username,
                buyer_tel: orderDto.phoneNumber,
                buyer_addr: orderDto.address + " " + orderDto.detailAddress,
            }, async function(rsp) {
                if(rsp.success){
                    alert("결제가 완료되었습니다.");

                    // 서버에 결제 데이터 전송
                    const paymentData = {
                        memberId: orderDto.memberId,
                        orderId: orderDto.orderId,
                        price: orderDto.totalPrice,
                        inventoryIdList: orderDto.cartIds || [],
                        impUid: rsp.imp_uid,
                        payMethod: orderDto.payMethod
                    };

                    try{
                        const res = await fetch("/api/v1/payment/" + rsp.imp_uid, {
                            method: "POST",
                            headers: {"Content-Type":"application/json"},
                            body: JSON.stringify(paymentData)
                        });
                        if(!res.ok) throw new Error("서버 결제 처리 실패");

                        alert("결제 내역이 서버에 저장되었습니다.");
                        sessionStorage.removeItem("orderDto");
                        window.location.href = "/order-complete";
                    } catch(err){
                        console.error(err);
                        alert("결제 완료 후 서버 처리 중 오류 발생");
                    }

                } else {
                    alert("결제에 실패했습니다. " + rsp.error_msg);
                }
            });
        });
    })();
</script>
</body>
</html>
