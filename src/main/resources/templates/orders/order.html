<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주문 및 결제</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/order.css">
    <link rel="stylesheet" href="/css/fragments/header.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body class="bg-light">

<!-- 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-5">
    <h2 class="mb-4">주문 및 결제</h2>

    <!-- 주문 요약 -->
    <div id="orderSummary" class="mb-4"></div>

    <form id="orderForm">
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="ordererName" class="form-label">주문자명</label>
                <input type="text" class="form-control" id="ordererName" readonly required>
            </div>
            <div class="col-md-6">
                <label for="phoneNumber" class="form-label">전화번호</label>
                <input type="text" class="form-control" id="phoneNumber" readonly required>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">배송지 선택</label>
            <div class="option-container d-flex gap-3">
                <div id="defaultBox" class="option-box active" data-value="default">기존 주소</div>
                <div id="newBox" class="option-box" data-value="new">새로운 주소 입력</div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">주소</label>
            <div class="input-group mb-2">
                <input type="text" class="form-control" id="postCode" placeholder="우편번호" readonly required>
                <button type="button" id="findAddressBtn" class="btn btn-outline-secondary" onclick="execDaumPostcode()" disabled>주소찾기</button>
            </div>
            <input type="text" class="form-control mb-2" id="address" placeholder="주소" readonly required>
            <input type="text" class="form-control" id="detailAddress" placeholder="상세주소 입력" required>
        </div>

        <button type="button" id="payBtn" class="btn btn-primary w-100">결제 진행</button>
    </form>
</div>

<script>
    // ====== Daum 주소 찾기 ======
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById('postCode').value = data.zonecode;
                document.getElementById('address').value = data.address;
                document.getElementById('detailAddress').focus();
            }
        }).open();
    }

    // ====== 메인 실행 ======
    (async function initOrderPage() {
        const orderDto = await loadOrderDto();
        if(!orderDto) return;

        await fillBuyerAndAddress(orderDto);    // 구매자 정보 + 기본 주소 세팅
        setupAddressBox(orderDto);              // 배송지 선택 이벤트
        setupPaymentButton(orderDto);           // 결제 버튼 이벤트
    })();

    // ====== 주문 정보 로드 ======
    async function loadOrderDto(){
        try {
            let orderDto = JSON.parse(sessionStorage.getItem("orderDto") || "null");
            if(!orderDto){
                const memberId = window.loginMemberId;
                if(!memberId){
                    alert("로그인 정보가 없습니다. 로그인 후 다시 시도해주세요.");
                    window.location.href = "/login";
                    return null;
                }

                const res = await fetch(`/api/v1/order/temp/${memberId}`);
                if(!res.ok) throw new Error("임시 주문 정보 없음");
                orderDto = await res.json();
                sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
            }
            return orderDto;
        } catch(err){
            console.error(err);
            alert("임시 주문 정보를 가져올 수 없습니다.");
            window.location.href = "/cart";
            return null;
        }
    }

    // ====== 구매자 정보 + 기본 주소 세팅 ======
    async function fillBuyerAndAddress(orderDto){
        try {
            const memberId = orderDto.memberId || window.loginMemberId;
            if(!memberId){
                alert("로그인 정보가 없습니다.");
                window.location.href = "/login";
                return;
            }

            const res = await fetch(`/api/v1/address/default/${memberId}`);
            const defaultAddress = res.ok ? await res.json() : {};

            const postCode = sessionStorage.getItem("postCode") || defaultAddress?.postCode || "";
            const address = sessionStorage.getItem("address") || defaultAddress?.address || "";
            const detailAddress = sessionStorage.getItem("detailAddress") || defaultAddress?.detailAddress || "";

            document.getElementById("ordererName").value = orderDto.ordererName || orderDto.username || "";
            document.getElementById("phoneNumber").value = orderDto.phoneNumber || orderDto.phone || "";
            document.getElementById("postCode").value = postCode;
            document.getElementById("address").value = address;
            document.getElementById("detailAddress").value = detailAddress;

            orderDto.defaultPost = postCode;
            orderDto.defaultAddr = address;
            orderDto.defaultDetail = detailAddress;

        } catch(err){
            console.error(err);
            alert("배송지 정보를 가져오지 못했습니다.");
        }
    }

    // ====== 배송지 선택 이벤트 ======
    function setupAddressBox(orderDto){
        const defaultBox = document.getElementById("defaultBox");
        const newBox = document.getElementById("newBox");

        function activateBox(selected, other){
            selected.classList.add("active");
            other.classList.remove("active");
        }

        defaultBox.addEventListener("click", () => {
            activateBox(defaultBox, newBox);
            document.getElementById("findAddressBtn").disabled = true;
            document.getElementById("postCode").readOnly = true;
            document.getElementById("address").readOnly = true;

            document.getElementById("postCode").value = orderDto.defaultPost || "";
            document.getElementById("address").value = orderDto.defaultAddr || "";
            document.getElementById("detailAddress").value = orderDto.defaultDetail || "";
        });

        newBox.addEventListener("click", () => {
            activateBox(newBox, defaultBox);
            document.getElementById("findAddressBtn").disabled = false;
            document.getElementById("postCode").readOnly = false;
            document.getElementById("address").readOnly = false;

            document.getElementById("postCode").value = "";
            document.getElementById("address").value = "";
            document.getElementById("detailAddress").value = "";
        });
    }

    // ====== 결제 버튼 이벤트 ======
    function setupPaymentButton(orderDto){
        document.getElementById("payBtn").addEventListener("click", async function(){
            orderDto.postCode = document.getElementById("postCode").value;
            orderDto.address = document.getElementById("address").value;
            orderDto.detailAddress = document.getElementById("detailAddress").value;

            sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
            sessionStorage.setItem("postCode", orderDto.postCode);
            sessionStorage.setItem("address", orderDto.address);
            sessionStorage.setItem("detailAddress", orderDto.detailAddress);

            const IMP = window.IMP;
            IMP.init("imp05078720");

            IMP.request_pay({
                pg: "html5_inicis",
                merchant_uid: `order_${new Date().getTime()}`,
                name: "주문 상품",
                amount: orderDto.totalPrice || 0,
                buyer_name: orderDto.username || "",
                buyer_tel: orderDto.phoneNumber || "",
                buyer_addr: (orderDto.address || "") + " " + (orderDto.detailAddress || ""),
            }, async function(rsp){
                if(rsp.success){
                    alert("결제가 완료되었습니다.");
                    const paymentData = {
                        memberId: orderDto.memberId,
                        orderId: orderDto.orderId,
                        price: orderDto.totalPrice,
                        inventoryIdList: orderDto.cartIds || [],
                        impUid: rsp.imp_uid,
                    };

                    try{
                        const res = await fetch("/api/v1/payment/" + rsp.imp_uid, {
                            method: "POST",
                            headers: {"Content-Type":"application/json"},
                            body: JSON.stringify(paymentData)
                        });
                        if(!res.ok) throw new Error("서버 결제 처리 실패");

                        alert("결제 내역이 서버에 저장되었습니다.");
                        sessionStorage.removeItem("orderDto");
                        sessionStorage.removeItem("postCode");
                        sessionStorage.removeItem("address");
                        sessionStorage.removeItem("detailAddress");
                        window.location.href = "/order-complete";
                    } catch(err){
                        console.error(err);
                        alert("결제 완료 후 서버 처리 중 오류가 발생했습니다. 고객센터에 문의해주세요.");
                    }
                } else {
                    alert("결제에 실패했습니다. " + (rsp.error_msg || ""));
                }
            });
        });
    }
</script>
</body>
</html>
