<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title th:text="${product.productName}">ìƒí’ˆ ìƒì„¸</title>
    <link rel="stylesheet" href="/css/fragments/header.css" />
    <link rel="stylesheet" href="/css/productDetail.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<!-- í—¤ë” -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- productDetail.html -->
<main class="product-detail-container">
    <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
    <section class="image-section">
        <img th:src="@{/{path}(path=${product.thumbnailUrl})}" alt="ëŒ€í‘œ ì´ë¯¸ì§€" class="product-image" />
    </section>

    <!-- ìƒí’ˆ ì •ë³´ ì˜ì—­ -->
    <section class="info-section">
        <h1 class="product-title" th:text="${product.productName}">ìƒí’ˆëª…</h1>

        <div class="price-info">
            <span class="product-original-price" th:if="${product.isDiscount}"
                  th:text="'â‚©' + ${#numbers.formatInteger(product.price, 0, 'COMMA')}"></span>
            <span class="product-discount" th:if="${product.isDiscount}"
                  th:text="${product.discountRate + '% í• ì¸'}"></span>
            <span class="product-price"
                  th:text="'â‚©' + ${#numbers.formatInteger(product.isDiscount ? product.price * (1 - product.discountRate / 100.0) : product.price, 0, 'COMMA')}"></span>
        </div>

        <!-- ì˜µì…˜ ì„ íƒ -->
        <div class="product-options">
            <label>ì‚¬ì´ì¦ˆ</label>
            <div class="size-options">
                <button type="button" th:each="dto : ${product.sizes}"
                        th:text="${dto.size.description}"
                        th:attr="data-inventory-id=${dto.inventoryId}"
                        class="size-button"></button>
            </div>
        </div>

        <!-- ìˆ˜ëŸ‰ ì„ íƒ -->
        <div class="quantity-selection">
            <label for="quantity">ìˆ˜ëŸ‰</label>
            <input type="number" id="quantity" name="quantity" value="1" min="1" class="quantity-input" />
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="action-buttons">
            <button type="button" class="add-to-cart-btn">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
            <button type="button" class="buy-now-btn">âš¡ ë°”ë¡œ ì£¼ë¬¸í•˜ê¸°</button>
        </div>
    </section>
</main>

<script>
    let selectedInventoryId = null;

    // ì‚¬ì´ì¦ˆ ì„ íƒ
    document.querySelector(".size-options").addEventListener("click", (e) => {
        const btn = e.target.closest(".size-button");
        if (!btn) return;

        document.querySelectorAll(".size-button").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedInventoryId = btn.getAttribute("data-inventory-id");
    });

    // íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    async function fetchMemberInfo() {
        const res = await fetch('/api/v1/member/me', { credentials: 'include' });
        if (!res.ok) throw new Error("íšŒì› ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");
        return res.json();
    }

    // ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
    document.querySelector(".add-cart-btn").addEventListener("click", async () => {
        const quantity = parseInt(document.getElementById("quantity").value);
        if (!selectedInventoryId) return alert("ì‚¬ì´ì¦ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

        try {
            const res = await fetch(`/api/v1/cart/add/${selectedInventoryId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ quantity })
            });
            if (!res.ok) throw new Error("ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì‹¤íŒ¨");
            alert(await res.text());
            location.href = "/cart";
        } catch (err) { alert(err.message); }
    });

    // ë°”ë¡œ ì£¼ë¬¸
    document.querySelector(".order-now-btn").addEventListener("click", async () => {
        if (!selectedInventoryId) return alert("ì‚¬ì´ì¦ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        const quantity = parseInt(document.getElementById("quantity").value);
        if (quantity < 1) return alert("ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");

        const memberInfo = await fetchMemberInfo();
        const productName = document.querySelector(".product-name").innerText;
        const size = document.querySelector(".size-btn.selected").innerText;
        const image = document.querySelector(".main-image").getAttribute("src");
        const priceText = document.querySelector(".discounted-price").innerText.replace(/[â‚©,]/g,'');
        const price = parseInt(priceText, 10);

        const orderDto = {
            memberId: memberInfo.memberId,
            totalPrice: price * quantity,
            ordererName: memberInfo.username,
            phoneNumber: memberInfo.phoneNumber,
            productNames: [productName],
            productSizes: [size],
            productImages: [image],
            productQuantities: [quantity]
        };

        sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
        location.href = "/tempOrder";
    });
</script>
