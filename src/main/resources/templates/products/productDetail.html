<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title th:text="${product.productName}">상품 상세</title>
    <link rel="stylesheet" href="/css/fragments/header.css" />
    <link rel="stylesheet" href="/css/productDetail.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<!-- 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- productDetail.html -->
<main class="product-detail-container">
    <!-- 이미지 영역 -->
    <section class="image-section">
        <img th:src="@{/{path}(path=${product.thumbnailUrl})}" alt="대표 이미지" class="product-image" />
    </section>

    <!-- 상품 정보 영역 -->
    <section class="info-section">
        <h1 class="product-title" th:text="${product.productName}">상품명</h1>

        <div class="price-info">
            <span class="product-original-price" th:if="${product.isDiscount}"
                  th:text="'₩' + ${#numbers.formatInteger(product.price, 0, 'COMMA')}"></span>
            <span class="product-discount" th:if="${product.isDiscount}"
                  th:text="${product.discountRate + '% 할인'}"></span>
            <span class="product-price"
                  th:text="'₩' + ${#numbers.formatInteger(product.isDiscount ? product.price * (1 - product.discountRate / 100.0) : product.price, 0, 'COMMA')}"></span>
        </div>

        <!-- 옵션 선택 -->
        <div class="product-options">
            <label>사이즈</label>
            <div class="size-options">
                <button type="button" th:each="dto : ${product.sizes}"
                        th:text="${dto.size.description}"
                        th:attr="data-inventory-id=${dto.inventoryId}"
                        class="size-button"></button>
            </div>
        </div>

        <!-- 수량 선택 -->
        <div class="quantity-selection">
            <label for="quantity">수량</label>
            <input type="number" id="quantity" name="quantity" value="1" min="1" class="quantity-input" />
        </div>

        <!-- 액션 버튼 -->
        <div class="action-buttons">
            <button type="button" class="add-to-cart-btn">장바구니 담기</button>
            <button type="button" class="buy-now-btn">바로 주문하기</button>
        </div>
    </section>
</main>

<script>
    let selectedInventoryId = null;

    // 사이즈 선택
    document.querySelector(".size-options").addEventListener("click", (e) => {
        const btn = e.target.closest(".size-button");
        if (!btn) return;

        document.querySelectorAll(".size-button").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedInventoryId = btn.getAttribute("data-inventory-id");
    });

    // 회원 정보 가져오기
    async function fetchMemberInfo() {
        const res = await fetch('/api/v1/member/me', { credentials: 'include' });
        if (!res.ok) throw new Error("회원 정보 조회 실패");
        return res.json();
    }

    // 장바구니 담기
    document.querySelector(".add-to-cart-btn").addEventListener("click", async () => {
        const quantity = parseInt(document.getElementById("quantity").value);
        if (!selectedInventoryId) return alert("사이즈를 선택해주세요.");

        try {
            const res = await fetch(`/api/v1/cart/add/${selectedInventoryId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ quantity })
            });
            if (!res.ok) throw new Error("장바구니 추가 실패");
            alert(await res.text());
            location.href = "/cart";
        } catch (err) { alert(err.message); }
    });

    // 바로 주문
    document.querySelector(".buy-now-btn").addEventListener("click", async () => {
        if (!selectedInventoryId) return alert("사이즈를 선택해주세요.");
        const quantity = parseInt(document.getElementById("quantity").value);
        if (quantity < 1) return alert("수량은 1개 이상이어야 합니다.");

        // 회원 정보 API 호출
        const memberInfo = await fetchMemberInfo();
        const productName = document.querySelector(".product-name").innerText;
        const size = document.querySelector(".size-btn.selected").innerText;
        const image = document.querySelector(".main-image").getAttribute("src");
        const priceText = document.querySelector(".discounted-price").innerText.replace(/[₩,]/g,'');
        const price = parseInt(priceText, 10);

        const orderDto = {
            memberId: memberInfo.memberId,
            totalPrice: price * quantity,
            ordererName: memberInfo.ordererName,
            phoneNumber: memberInfo.phoneNumber,
            productNames: [productName],
            productSizes: [size],
            productImages: [image],
            productQuantities: [quantity]
        };

        sessionStorage.setItem("orderDto", JSON.stringify(orderDto));
        location.href = "/tempOrder";
    });
</script>
