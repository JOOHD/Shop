<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì ì£¼ë¬¸ ë‚´ì—­</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/admin/orderList.css">
    <link rel="stylesheet" href="/css/fragments/header.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">

<!-- í—¤ë” -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-5">
    <h2 class="mb-4">ğŸ“¦ ì£¼ë¬¸ ê´€ë¦¬</h2>

    <!-- í•„í„° & ê²€ìƒ‰ -->
    <div class="row mb-3">
        <div class="col-md-3">
            <select id="orderStatusFilter" class="form-select">
                <option value="">ì „ì²´ ìƒíƒœ</option>
                <option value="PENDING">ê²°ì œ ëŒ€ê¸°</option>
                <option value="PAID">ê²°ì œ ì™„ë£Œ</option>
                <option value="SHIPPED">ë°°ì†¡ ì¤‘</option>
                <option value="DELIVERED">ë°°ì†¡ ì™„ë£Œ</option>
            </select>
        </div>
        <div class="col-md-5">
            <input type="text" id="searchKeyword" class="form-control" placeholder="ì£¼ë¬¸ìëª… / ì£¼ë¬¸ë²ˆí˜¸ ê²€ìƒ‰">
        </div>
        <div class="col-md-2">
            <button id="searchBtn" class="btn btn-primary w-100">ê²€ìƒ‰</button>
        </div>
    </div>

    <!-- ì£¼ë¬¸ ëª©ë¡ í…Œì´ë¸” -->
    <div class="table-responsive">
        <table class="table table-hover align-middle" id="orderTable">
            <thead class="table-light">
            <tr>
                <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                <th>ì£¼ë¬¸ì</th>
                <th>ì „í™”ë²ˆí˜¸</th>
                <th>ì´ ê²°ì œê¸ˆì•¡</th>
                <th>ì£¼ë¬¸ ìƒíƒœ</th>
                <th>ì£¼ë¬¸ì¼ì‹œ</th>
                <th>ìƒì„¸ë³´ê¸°</th>
            </tr>
            </thead>
            <tbody>
            <!-- JSë¡œ ë Œë”ë§ -->
            </tbody>
        </table>
    </div>
</div>

<!-- ì£¼ë¬¸ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì£¼ë¬¸ ìƒì„¸</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="orderDetailContainer">
                    <!-- JSë¡œ ìƒì„¸ ë Œë”ë§ -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {

        async function loadOrders(filter = {}, keyword = "") {
            try {
                let query = new URLSearchParams();
                if (filter.status) query.append("status", filter.status);
                if (keyword) query.append("keyword", keyword);

                const res = await fetch("/api/v1/admin/orders?" + query.toString());
                if (!res.ok) throw new Error("ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨");

                const orders = await res.json();
                renderOrderTable(orders);
            } catch(e) {
                console.error(e);
                alert("ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
    }

    function renderOrderTable(orders) {
        const tbody = document.querySelector("#orderTable tbody");
        tbody.innerHTML = "";

        if (!orders || orders.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center">ë“±ë¡ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            return;
        }

        orders.forEach(o => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${o.orderId}</td>
                <td>${o.ordererName}</td>
                <td>${o.phoneNumber}</td>
                <td>${o.totalPrice.toLocaleString()}ì›</td>
                <td>${o.status}</td>
                <td>${new Date(o.orderDate).toLocaleString()}</td>
                <td><button class="btn btn-sm btn-outline-primary view-detail-btn" data-order-id="${o.orderId}">ìƒì„¸ë³´ê¸°</button></td>
            `;
            tbody.appendChild(tr);
        });

        // ìƒì„¸ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll(".view-detail-btn").forEach(btn => {
            btn.addEventListener("click", async (e) => {
                const orderId = e.target.dataset.orderId;
                const res = await fetch(`/api/v1/admin/orders/${orderId}`);
                if (!res.ok) return alert("ì£¼ë¬¸ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨");
                const order = await res.json();
                renderOrderDetailModal(order);
                const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
                modal.show();
            });
        });
    }

    function renderOrderDetailModal(order) {
        const container = document.getElementById("orderDetailContainer");
        let html = `
            <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${order.orderId}</p>
            <p><strong>ì£¼ë¬¸ì:</strong> ${order.ordererName}</p>
            <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${order.phoneNumber}</p>
            <p><strong>ë°°ì†¡ì§€:</strong> ${order.address} ${order.detailAddress}</p>
            <p><strong>ì´ ê²°ì œê¸ˆì•¡:</strong> ${order.totalPrice.toLocaleString()}ì›</p>
            <p><strong>ì£¼ë¬¸ ìƒíƒœ:</strong> ${order.status}</p>
            <hr>
            <h6>ì£¼ë¬¸ ìƒí’ˆ</h6>
            <ul class="list-group">`;
        order.products.forEach(p => {
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        ${p.name} (${p.size}) x ${p.quantity} - ${p.price.toLocaleString()}ì›
                    </li>`;
        });
        html += `</ul>`;
        container.innerHTML = html;
    }

    // í•„í„° & ê²€ìƒ‰ ì´ë²¤íŠ¸
    document.getElementById("searchBtn").addEventListener("click", () => {
        const status = document.getElementById("orderStatusFilter").value;
        const keyword = document.getElementById("searchKeyword").value;
        loadOrders({status}, keyword);
    });

    // ì´ˆê¸° ë¡œë“œ
    loadOrders();
});
</script>