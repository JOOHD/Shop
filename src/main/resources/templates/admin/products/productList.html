<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>관리자 상품 목록</title>
    <link rel="stylesheet" href="/css/fragments/header.css">
    <link rel="stylesheet" href="/css/admin/productList.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<!-- 관리자 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>
<div class="overlay" onclick="toggleSidebar()"></div>

<!-- 상단 관리 바 -->
<section class="admin-toolbar">
    <h2>상품 관리</h2>
    <div class="actions">
        <button onclick="location.href='/admin/products/register'" class="btn-primary">
            <i class="fas fa-plus"></i> 상품 등록
        </button>
        <select>
            <option>전체</option>
            <option>판매 중</option>
            <option>품절</option>
        </select>
    </div>
</section>

<!-- 상품 목록 테이블 -->
<main class="admin-product-list">
    <table>
        <thead>
        <tr>
            <th>썸네일</th>
            <th>상품명</th>
            <th>가격</th>
            <th>상품 정보</th>
            <th>등록일</th>
            <th>관리</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="product : ${products}">
            <td class="thumb">
                <img th:if="${product.thumbnailUrl != null}"
                     th:src="${product.thumbnailUrl}" alt="상품 이미지" />
            </td>
            <td th:text="${product.productName}">상품명</td>
            <td th:text="'₩' + ${#numbers.formatInteger(product.price, 0, 'COMMA')}">₩0</td>
            <td th:text="${product.productInfo}">상품 정보</td>
            <td th:text="${#temporals.format(product.createdAt, 'yyyy-MM-dd')}">2025-10-13</td>
            <td class="actions">
                <button th:onclick="|location.href='/admin/products/edit/' + ${product.productId}|"
                        class="btn-edit">
                    <i class="fas fa-edit"></i> 수정
                </button>
                <button th:onclick="|deleteProduct(${product.productId})|" class="btn-delete">
                    <i class="fas fa-trash"></i> 삭제
                </button>
            </td>
        </tr>
        </tbody>
    </table>
</main>

<script>
    function toggleSidebar() {
        document.querySelector('.sidebar')?.classList.toggle('active');
        document.querySelector('.overlay')?.classList.toggle('active');
    }

    // JWT 쿠키 포함 DELETE 요청
    function deleteProduct(productId) {
        if (!confirm("정말 삭제하시겠습니까?")) return;

        fetch(`/api/admin/products/${productId}`, {
            method: 'DELETE',
            credentials: 'include', // HttpOnly JWT 쿠키 포함
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(async res => {
            if (res.ok) {
                alert("삭제되었습니다.");
                location.reload();
            } else {
                const data = await res.json().catch(() => ({}));
                if (res.status === 401) {
                    alert(data.message || "로그인이 필요합니다.");
                } else if (res.status === 403) {
                    alert(data.message || "권한이 없습니다. 관리자 계정으로 로그인해주세요.");
                } else {
                    alert(data.message || "삭제 중 오류가 발생했습니다.");
                }
            }
        })
        .catch(err => {
            console.error("삭제 요청 오류:", err);
            alert("서버 요청 중 오류가 발생했습니다.");
        });
    }
</script>

</body>
</html>
