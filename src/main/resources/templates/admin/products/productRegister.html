<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>상품 등록 - 관리자</title>
    <link rel="stylesheet" href="/css/fragments/header.css" />
    <link rel="stylesheet" href="/css/admin/productRegister.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<main class="admin-register-container">
    <h1 class="page-title"><i class="fa-solid fa-shirt"></i> 상품 등록</h1>

    <form id="productForm">
        <!-- 기본 정보 -->
        <section class="form-section">
            <h2>기본 정보</h2>
            <label>상품명</label>
            <input type="text" name="productName" placeholder="예: 2025 맨유 홈 저지" required />

            <label>상품 타입</label>
            <select name="productType" required>
                <option value="">-- 선택 --</option>
                <option value="HOME_JERSEY">홈 저지</option>
                <option value="AWAY_JERSEY">어웨이 저지</option>
                <option value="THIRD_JERSEY">서드 저지</option>
                <option value="LONG_SLEEVE">롱슬리브</option>
                <option value="TRAINING_WEAR">트레이닝 웨어</option>
                <option value="ACCESSORY">액세서리</option>
            </select>

            <label>가격</label>
            <input type="number" name="price" placeholder="₩ 금액" required />

            <label>할인율(%)</label>
            <input type="number" name="discountRate" value="0" min="0" max="100" />

            <label>상품 설명</label>
            <textarea name="description" rows="5" placeholder="상품에 대한 상세 설명을 입력하세요."></textarea>
        </section>

        <!-- 이미지 등록 (MultipartFile / 기존 이미지 선택) -->
        <section class="form-section">
            <h2>이미지 등록 (파일 업로드)</h2>

            <!-- thumbnail -->
            <label>썸네일 </label>
            <input type="file" id="thumbnailFileInput" name="thumbnailFile" accept="image/*" required />
            <img id="thumbnailPreview" alt="미리보기" style="display:none;"/>

            <!-- contentImgs -->
            <label>상세 이미지 </label>
            <input type="file" id="contentFilesInput" name="contentFiles" accept="image/*" multiple />
            <div id="contentPreview"></div>
        </section>

        <!-- 옵션 -->
        <section class="form-section">
            <h2>옵션 등록</h2>
            <div id="optionContainer">
                <div class="option-row">
                    <select name="gender" required>
                        <option value="">성별 선택</option>
                        <option value="MAN">남성</option>
                        <option value="WOMAN">여성</option>
                        <option value="UNISEX">유니섹스</option>
                    </select>
                    <input type="text" name="size" placeholder="사이즈 (예: M)" required />
                    <input type="number" name="stock" placeholder="재고 수량" required />
                    <button type="button" class="remove-option-btn"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <button type="button" id="addOptionBtn" class="add-option-btn"><i class="fa-solid fa-plus"></i> 옵션 추가</button>
        </section>

        <!-- 액션 -->
        <div class="action-buttons">
            <button type="submit" class="register-btn">상품 등록</button>
            <button type="button" class="cancel-btn" onclick="history.back()">취소</button>
        </div>
    </form>
</main>

<script>
// === 썸네일 미리보기 ===
const thumbnailFileInput = document.getElementById("thumbnailFileInput");
const thumbnailPreview = document.getElementById("thumbnailPreview");

thumbnailFileInput.addEventListener("change", () => {
    const file = thumbnailFileInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e =>  {
            thumbnailPreview.src = e.target.result;
            thumbnailPreview.style.display = "block"; // 선택 시 보여줌
        };
        reader.readAsDataURL(file);
    } else {
        thumbnailPreview.src = "";
        thumbnailPreview.style.display = "none"; // 선택 없으면 숨김
    }
});

// === 상세 이미지 미리보기 ===
const contentFilesInput = document.getElementById("contentFilesInput");
const contentPreview = document.getElementById("contentPreview");

contentFilesInput.addEventListener("change", () => {
    contentPreview.innerHTML = "";
    Array.from(contentFilesInput.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.classList.add("content-preview-img");
            contentPreview.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
});

// === 상품 등록 요청 (Multipart) ===
document.getElementById("productForm").addEventListener("submit", async e => {
    e.preventDefault();

    // 썸네일 선택 여부 체크
    if (!thumbnailFileInput.files[0]) {
        alert("썸네일를 선택해주세요.");
        return;
    }

    const formData = new FormData();
    formData.append("productName", e.target.productName.value);
    formData.append("productType", e.target.productType.value);
    formData.append("price", e.target.price.value);
    formData.append("discountRate", e.target.discountRate.value);
    formData.append("description", e.target.description.value);

    // 썸네일 파일
    formData.append("thumbnailFile", thumbnailFileInput.files[0]);

    // 상세 이미지 파일 (여러 개)
    Array.from(contentFilesInput.files).forEach(file => {
        formData.append("contentFiles", file);
    });

    // 옵션
    const optionRows = document.querySelectorAll("#optionContainer .option-row");
    optionRows.forEach((row, idx) => {
        const gender = row.querySelector('select[name="gender"]').value;
        const size = row.querySelector('input[name="size"]').value;
        const stock = row.querySelector('input[name="stock"]').value;
        formData.append(`options[${idx}].gender`, gender);
        formData.append(`options[${idx}].size`, size);
        formData.append(`options[${idx}].stock`, stock);
    });

    try {
        const res = await fetch("/api/admin/products", { // AdminProductApiController 기준
            method: "POST",
            body: formData,
            credentials: "include"
        });
        if (!res.ok) throw new Error("상품 등록 실패");
        alert("상품이 등록되었습니다!");
        location.href = "/admin/products";
    } catch (err) {
        console.error(err);
        alert(err.message);
    }
});
</script>

</body>
</html>
